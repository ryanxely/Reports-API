<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="icon" type="image/png" href="favicon.png" />
    
    <title>Rapports ‚Äî Mini App</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Chokokutai&display=swap" rel="stylesheet">


    <!-- Quill.js (rich text editor) -->
    <!-- <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script> -->
    <link href="styles/quill.snow.css" rel="stylesheet">
    <script src="js/quill.min.js"></script>

    <link rel="stylesheet" href="./styles/utils.css">
    <link rel="stylesheet" href="./styles/view.css">
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="title">
                <h1 id="pageTitle">Mes rapports</h1>
                <p id="userInfo">Chargement...</p>
            </div>
            <nav>
                <a href="index.html" class="nav-link">‚Üê Cr√©er un rapport</a>
                <a href="profile.html" class="nav-link">üë§ Profil</a>
                <button class="logout-btn" onclick="handleLogout()">üîó D√©connexion</button>
            </nav>
        </div>

        <div class="nav-buttons" style="display: none">
            <button id="btnListView" class="active">üìã Tous les rapports</button>
            <button id="btnViewReport" style="display: none;">üëÅÔ∏è Visualiser le rapport</button>
            <button id="btnEditView" style="display: none;">‚úèÔ∏è Modifier le rapport</button>
        </div>

        <div id="statusMessage" class="status"></div>

        <!-- List View -->
        <div id="listView" class="view active">
            <div id="reportsList" class="reports-grid">
                <div class="loading">Chargement de vos rapports...</div>
            </div>
        </div>

        <!-- Edit View -->
        <div id="editView" class="view">
            <div class="edit-form">
                <h2 style="margin-bottom: 20px; color: #2d3748;">Modifier le rapport</h2>

                <!-- Title Card -->
                <div class="title-card form-group">
                    <label>Titre</label>
                    <input id="editTitle" placeholder="Titre du rapport" required />
                </div>

                <!-- Content Accordion Section -->
                <div class="editor-card accordion-section form-group">
                    <div class="accordion-header" onclick="toggleAccordion('edit-content')">
                        <label>‚úçÔ∏è Contenu</label>
                        <span class="accordion-icon" id="edit-content-icon" style="transform: rotate(-90deg)">‚ñº</span>
                    </div>
                    <div class="accordion-content collapsed" id="edit-content-content">
                        <div id="editEditor"></div>
                    </div>
                </div>

                <!-- Attachments Accordion Section -->
                <div class="form-row accordion-section form-group">
                    <div class="accordion-header" onclick="toggleAccordion('attachments')">
                        <label>üìé Pi√®ces jointes</label>
                        <span class="accordion-icon" id="attachments-icon" style="transform: rotate(-90deg)">‚ñº</span>
                    </div>

                    <div class="form-row accordion-section">
                        <div class="accordion-content collapsed" id="attachments-content">
                            <!-- Existing Files -->
                            <div id="existingFilesContainer" style="margin-bottom:16px;"></div>

                            <!-- New Files Upload -->
                            <div class="file-upload-area" id="editFileUploadArea">
                                <input type="file" id="editFileInput"
                                    accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar"
                                    multiple />
                                <div class="file-upload-text">
                                    <strong>Cliquez pour s√©lectionner</strong> ou glissez-d√©posez vos fichiers<br>
                                    <small>Images, vid√©os, audio, documents (PDF, Word, Excel, etc.)</small>
                                </div>
                            </div>
                            <div id="preview" class="preview"></div>
                        </div>
                    </div>

                </div>

                <!-- Extra Fields Accordion Section -->
                <div class="form-row accordion-section form-group">
                    <div class="accordion-header" onclick="toggleAccordion('edit-extra-fields')">
                        <label>üîñ Champs personnalis√©s</label>
                        <span class="accordion-icon" id="edit-extra-fields-icon" style="transform: rotate(-90deg)">‚ñº</span>
                    </div>
                    <div class="accordion-content collapsed" id="edit-extra-fields-content" style="max-height: 0px;">
                        <div id="editExtraFieldsContainer" class="extra-fields-container">
                            <table class="extra-fields-table">
                                <thead>
                                    <tr>
                                        <th>Cl√©</th>
                                        <th>Valeur</th>
                                        <th style="width: 60px;">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="editExtraFieldsBody">
                                    <!-- Extra field rows will be added here -->
                                </tbody>
                            </table>
                            <button type="button" class="add-field-btn" onclick="addEditExtraField()">+ Ajouter un champ</button>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="form-actions">
                    <button class="btn btn-primary" id="btnSaveEdit">
                        <span>üíæ Enregistrer</span>
                        <div class="loading-spinner"></div>
                    </button>
                    <button class="btn btn-secondary" id="btnCancelEdit">Annuler</button>
                </div>
            </div>
        </div>

        <!-- Visualize View (admin) -->
        <div id="viewReport" class="view">
            <div class="edit-form">
                <h2 style="margin-bottom: 12px; color: #2d3748;">Visualisation du rapport</h2>
                <div id="reportFullTitle"
                    style="font-size:20px;font-weight:700;margin-bottom:8px;color:var(--text-primary);"></div>
                <div id="reportFullMeta" style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;"></div>
                <div id="reportFullContent"
                    style="background:var(--bg-light);padding:16px;border-radius:10px;width:100%;margin-bottom:12px;color:var(--text-secondary);">
                </div>
                <div id="reportFullAttachments" style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;"></div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="switchView('list')">Retour</button>
                </div>
            </div>
        </div>

        <!-- Single Report View (by URL parameter) -->
        <div id="singleReportView" class="view">
            <div class="edit-form">
                <!-- <h2 style="margin-bottom: 12px; color: #2d3748;">Rapport</h2> -->
                <div id="singleReportTitle"
                    style="font-size:20px;font-weight:700;margin-bottom:8px;color:var(--text-primary);"></div>
                <div id="singleReportMeta" style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;"></div>
                <div id="singleReportContent"
                    style="background:var(--bg-light);padding:16px;border-radius:10px;width:100%;margin-bottom:12px;color:var(--text-secondary);">
                </div>
                <div id="singleReportAttachments" style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;"></div>
                <div id="singleReportExtraFields" style="margin-bottom:12px;"></div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="backFromSingleReport()">‚Üê Retour</button>
                    <button class="btn" id="shareReportBtn" style="background:#009688;color:white;" >üì§ Partager</button>
                </div>
            </div>
        </div>
    </div>

    <!-- File Preview Modal -->
    <div id="filePreviewModal" class="file-preview-modal">
        <div class="file-preview-content">
            <div class="file-preview-header">
                <div class="file-preview-title" id="previewTitle">Aper√ßu du fichier</div>
                <button class="file-preview-close" onclick="closeFilePreview()">&times;</button>
            </div>
            <div class="file-preview-body" id="previewBody">
                <!-- Content will be injected here -->

            </div>
            <div class="file-preview-actions">
                <a id="previewDownloadBtn" class="file-preview-download" download>‚¨áÔ∏è T√©l√©charger</a>
            </div>
        </div>
    </div>

    <!-- (removed unused modal; admin visualizer now uses the Visualize tab) -->

    <!-- Telegram Web App script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script src="config.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/api.js"></script>
    <script src="js/dom-helpers.js"></script>
    <script src="js/file-previews.js"></script>
    <script>
        // ===== Auth Check =====
        requireAuth();

        // Logout handler
        window.handleLogout = function () {
            logout();
            window.location.href = 'login.html';
        };

        // ===== Configuration =====
        const REPORTS_API_URL = getApiUrl(CONFIG.REPORTS_GET);
        const USERS_API_URL = getApiUrl(CONFIG.USERS_GET);

        // ===== Telegram WebApp =====
        const tg = window.Telegram?.WebApp;
        tg?.expand();

        // ===== State Management =====
        let currentView = 'list';
        let currentEditingReport = null;
        let allReports = [];
        let allUsers = [];
        let editQuill = null;

        // ===== DOM Elements =====
        const listView = document.getElementById('listView');
        const editView = document.getElementById('editView');
        const viewReportView = document.getElementById('viewReport');
        const btnListView = document.getElementById('btnListView');
        const btnViewReport = document.getElementById('btnViewReport');
        const btnEditView = document.getElementById('btnEditView');
        const reportsList = document.getElementById('reportsList');
        const statusMessage = document.getElementById('statusMessage');
        const userInfo = document.getElementById('userInfo');
        const fileInput = document.getElementById('editFileInput');
        const previewEl = document.getElementById('preview');
        const singleReportView = document.getElementById('singleReportView');


        // ===== Initialize Quill for Edit View =====
        function initEditQuill() {
            if (!editQuill) {
                editQuill = new Quill('#editEditor', {
                    theme: 'snow',
                    placeholder: 'Modifiez le contenu de votre rapport...'
                });
            }
        }

        // ===== Show Status Message =====
        // Use the showStatus from dom-helpers.js - adapt for this custom element
        function displayStatus(message, isError = false) {
            statusMessage.innerText = message;
            statusMessage.className = isError ? 'status error' : 'status success';
            setTimeout(() => {
                statusMessage.className = 'status';
            }, 5000);
        }

        // ===== Switch Views =====
        function switchView(view) {
            currentView = view;

            if (view === 'list') {
                listView.classList.add('active');
                editView.classList.remove('active');
                if (viewReportView) viewReportView.classList.remove('active');
                btnListView.classList.add('active');
                if (btnViewReport) btnViewReport.classList.remove('active');
                btnEditView.classList.remove('active');
                btnEditView.style.display = 'none';
            } else if (view === 'edit') {
                listView.classList.remove('active');
                editView.classList.add('active');
                if (viewReportView) viewReportView.classList.remove('active');
                btnListView.classList.remove('active');
                if (btnViewReport) btnViewReport.classList.remove('active');
                btnEditView.classList.add('active');
                btnEditView.style.display = 'block';
                initEditQuill();
            } else if (view === 'visual') {
                // show the admin visualize tab
                listView.classList.remove('active');
                editView.classList.remove('active');
                if (viewReportView) viewReportView.classList.add('active');
                btnListView.classList.remove('active');
                if (btnViewReport) btnViewReport.classList.add('active');
                btnEditView.classList.remove('active');
                btnEditView.style.display = 'none';
            }
        }

        // ===== Fetch Reports =====
        async function fetchReports() {
            try {
                const apiKey = getApiKey('reports');
                if (!apiKey) {
                    displayStatus('Cl√© API des rapports manquante. Veuillez vous reconnecter.', true);
                    reportsList.innerHTML = '<div class="empty-state">Cl√© API manquante. Veuillez <a href="login.html">vous reconnecter</a>.</div>';
                    return;
                }

                const headers = {
                    'accept': 'application/json',
                    'x-api-key': apiKey
                };

                const authToken = getAuthToken();
                if (authToken) headers['Authorization'] = 'Bearer ' + authToken;

                const response = await fetch(REPORTS_API_URL, {
                    method: 'GET',
                    headers: headers
                });



                if (response.status === 401) {
                    // session expired
                    displayStatus('Session expir√©e. Redirection vers la page de connexion...', true);
                    handleSessionExpiry();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                console.log('Fetch reports response:', data);
                if (data.ok && data.reports) {
                    allReports = data.reports;
                    renderReports();
                } else {
                    displayStatus('Impossible de charger les rapports', true);
                }
            } catch (error) {
                console.error('Error fetching reports:', error);
                displayStatus('Erreur lors du chargement des rapports : ' + error.message, true);
                reportsList.innerHTML = '<div class="empty-state">√âchec du chargement des rapports. Veuillez r√©essayer.</div>';
            }
        }

        // ===== Fetch Users =====
        async function fetchUsers() {
            try {
                const apiKey = getApiKey('reports');
                if (!apiKey) {
                    displayStatus('Cl√© API des rapports manquante. Veuillez vous reconnecter.', true);
                    reportsList.innerHTML = '<div class="empty-state">Cl√© API manquante. Veuillez <a href="login.html">vous reconnecter</a>.</div>';
                    return;
                }

                const headers = {
                    'accept': 'application/json',
                    'x-api-key': apiKey
                };

                const authToken = getAuthToken();
                if (authToken) headers['Authorization'] = 'Bearer ' + authToken;

                const response = await fetch(USERS_API_URL, {
                    method: 'GET',
                    headers: headers
                });



                if (response.status === 401) {
                    // session expired
                    displayStatus('Session expir√©e. Redirection vers la page de connexion...', true);
                    handleSessionExpiry();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                console.log('Fetch users response:', data);
                if (data.ok && data.users) {
                    allUsers = data.users;
                } else {
                    displayStatus('Impossible de charger les donn√©es utilisateurs', true);
                }
            } catch (error) {
                console.error('Error fetching reports:', error);
                displayStatus('Erreur lors du chargement des utilisateurs', true);
            }
        }

        // ===== Render Reports =====
        function renderReports() {
            // Get logged-in user to check if admin


            const user = getUserProfile();
            const userIsAdmin = user && user.role === 'Administrator';

            // Show the Visualiser tab for admins
            if (btnViewReport) btnViewReport.style.display = userIsAdmin ? 'block' : 'none';

            if (userIsAdmin) {
                // Admin view: show all users' reports grouped by user, then by date
                renderAdminView();
            } else {
                // Regular user view: show only their own reports
                renderUserView();
            }
        }

        function renderUserView() {
            // For regular users, allReports is { items: { dates... }, user_id: X }
            // For admins, allReports is { "0": { items, user_id }, "1": { items, user_id }, ... }
            // This function handles the regular user structure

            const items = allReports?.items || {};
            const dayKeys = Object.keys(items);

            if (dayKeys.length === 0) {
                reportsList.innerHTML = '<div class="empty-state">Aucun rapport pour le moment. Cr√©ez votre premier rapport !</div>';
                return;
            }

            let html = '';

            // Sort days in descending order
            const sortedDays = dayKeys.sort((a, b) => {
                const dateA = new Date(a.split('-').reverse().join('-'));
                const dateB = new Date(b.split('-').reverse().join('-'));
                return dateB - dateA;
            });

            sortedDays.forEach(day => {
                const dayData = items[day];
                const records = dayData.records || [];

                console.log(`Rendering reports for day ${day}:`, records);

                if (records.length > 0) {
                    html += `<div class="day-section">
                        <div class="day-header">üìÖ ${day}</div>`;

                   
                    records.forEach(report => {
                        const contentText = report.content?.text || 'Aucun contenu';
                        const cleanText = String(contentText).replace(/<[^>]*>/g, '');
                        const contentPreview = cleanText.substring(0, 100);

                        // Prepare files markup placeholders; actual file blobs will be fetched and rendered after DOM insert
                        let filesHtml = '';
                        const files = report.content?.files || [];
                        if (files.length > 0) {
                            filesHtml += '<div class="report-files" style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">';
                            files.forEach(f => {
                                // Normalize stored path to subpath used by files endpoint (remove leading 'files\\' or 'files/')
                                const rawPath = f.path || f.name || '';
                                const subpath = (rawPath || '').replace(/^database\/files[\\/]/i, '').replace(/\\/g, '/');
                                const isImage = /\.(png|jpg|jpeg|gif|webp|bmp|svg)$/i.test(f.name || '');

                                // Escape single quotes for use in onclick attribute
                                const escapedSubpath = subpath.replace(/'/g, "\\'");
                                const escapedName = (f.name || '').replace(/'/g, "\\'");
                                const escapedType = (f.type || '').replace(/'/g, "\\'");

                                if (isImage) {
                                    filesHtml += `<img data-filepath="${subpath}" alt="${f.name}" style="width:80px;height:80px;object-fit:cover;border-radius:6px;background:#f0f0f0;cursor:pointer;" onclick="openFilePreview('${escapedSubpath}', '${escapedName}', '${escapedType}')" />`;
                                } else {
                                    filesHtml += `<button style="padding:8px 12px;border-radius:10px;background:var(--bg-white);border:1px solid var(--border-light);color:var(--text-primary);text-decoration:none;font-weight:600;font-size:13px;box-shadow:var(--shadow-sm);transition:all 0.3s ease;cursor:pointer;" onclick="openFilePreview('${escapedSubpath}', '${escapedName}', '${escapedType}')">${f.name}</button>`;
                                }
                            });
                            filesHtml += '</div>';
                        }

                        html += `
                            <div class="report-card">
                                <div class="report-title">${report.title}</div>
                                <div class="report-meta">üïê Cr√©e le ${report.created_at} ${report.last_edit_at && "‚Ä¢ Modifi√© le "} ${report.last_edit_at} ‚Ä¢ ID: ${report.id}</div>
                                <div class="report-content" style="cursor:pointer;" onclick="viewReportDetail(${report.id})">${contentPreview}${cleanText.length > 100 ? '...' : ''}</div>
                                ${filesHtml}
                                ${dayData.validated ? `<div class="report-validated">Se Rapport a deja ete valid√©</div>` : `<div class="report-actions"><button class="btn btn-edit" onclick="viewReportDetail(${report.id})">üëÅÔ∏è Voir</button> <button class="btn btn-edit" onclick="editReport(${report.id}, '${day}')">‚úèÔ∏è Modifier</button> <button class="btn btn-delete" onclick="deleteReport(${report.id})">üóëÔ∏è Supprimer</button> <button class="btn" onclick="shareReport(${report.id})" style="background:#52c41a;color:white;">üì§ Partager</button></div>`}
                            </div>
                        `;
                    });

                    html += `</div>`;
                }
            });

            reportsList.innerHTML = html || '<div class="empty-state">Aucun rapport trouv√©.</div>';
            // After inserting HTML, attempt to load file blobs for images and set links
            attachFilePreviews(reportsList);
        }


        function renderAdminView() {
            // Admin view: allReports is { "1": { items, user_id }, "2": { items, user_id }, ... }
            const reportsObj = allReports || {};
            const userIds = Object.keys(reportsObj).filter(key => !isNaN(key)).sort((a, b) => parseInt(a) - parseInt(b));

            if (userIds.length === 0) {
                reportsList.innerHTML = '<div class="empty-state">Aucun rapport pour le moment.</div>';
                return;
            }

            let html = '';

            userIds.forEach(userId => {
                const userData = reportsObj[userId];
                const userProfile = allUsers[userId] || {};
                const items = userData?.items || {};
                const dayKeys = Object.keys(items);

                console.log(`User ${userId} profile: ${JSON.stringify(userProfile)}`)

                if (dayKeys.length > 0) {
                    // User section header
                    let username = userProfile.username || `User ${userId}`
                    let fullname = userProfile.fullname || username
                    const avatarHtml = `<div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; margin-right: 12px; font-size: 14px;">${fullname.charAt(0).toUpperCase()}</div>`;

                    html += `<div style="background: rgba(102, 126, 234, 0.1); padding: 16px; margin-bottom: 16px; border-radius: 12px; border-left: 4px solid #009688;">
                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                    ${avatarHtml}
                    <div>
                        <div style="font-size: 16px; font-weight: 700; color: #2d3748;">üë§ ${fullname}</div>
                        <div style="font-size: 13px; color: #718096;">@${username}</div>
                    </div>
                </div>`;

                    // Sort days in descending order
                    const sortedDays = dayKeys.sort((a, b) => {
                        const dateA = new Date(a.split('-').reverse().join('-'));
                        const dateB = new Date(b.split('-').reverse().join('-'));
                        return dateB - dateA;
                    });

                    sortedDays.forEach(day => {
                        const dayData = items[day];
                        const records = dayData?.records || [];

                        if (records.length > 0) {
                            html += `<div class="day-section" style="margin-top: 12px;">
                        <div class="day-header">üìÖ ${day}</div>`;

                            records.forEach(report => {
                                // Handle null or empty content text properly
                                const contentText = report.content?.text || 'Aucun contenu';
                                const cleanText = String(contentText).replace(/<[^>]*>/g, '');
                                const contentPreview = cleanText.substring(0, 100);

                                // Escape quotes for onclick attributes
                                const escapedDay = String(day).replace(/'/g, "\\'");

                                // Prepare files markup with preview modal
                                let filesHtml = '';
                                const files = report.content?.files || [];
                                if (files.length > 0) {
                                    filesHtml += '<div class="report-files" style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">';
                                    files.forEach(f => {
                                        const rawPath = f.path || f.name || '';
                                        const subpath = (rawPath || '').replace(/^database\/files[\\/]/i, '').replace(/\\/g, '/');
                                        const isImage = /\.(png|jpg|jpeg|gif|webp|bmp|svg)$/i.test(f.name || '');

                                        // Escape single quotes for use in onclick attribute
                                        const escapedSubpath = subpath.replace(/'/g, "\\'");
                                        const escapedName = (f.name || '').replace(/'/g, "\\'");
                                        const escapedType = (f.type || '').replace(/'/g, "\\'");

                                        if (isImage) {
                                            filesHtml += `<img data-filepath="${subpath}" alt="${f.name}" style="width:80px;height:80px;object-fit:cover;border-radius:6px;background:#f0f0f0;cursor:pointer;" onclick="openFilePreview('${escapedSubpath}', '${escapedName}', '${escapedType}')" />`;
                                        } else {
                                            filesHtml += `<button style="padding:8px 12px;border-radius:10px;background:var(--bg-white);border:1px solid var(--border-light);color:var(--text-primary);text-decoration:none;font-weight:600;font-size:13px;box-shadow:var(--shadow-sm);transition:all 0.3s ease;cursor:pointer;" onclick="openFilePreview('${escapedSubpath}', '${escapedName}', '${escapedType}')">${f.name}</button>`;
                                        }
                                    });
                                    filesHtml += '</div>';
                                }

                                html += `
                            <div class="report-card">
                                <div class="report-title">${report.title}</div>
                                <div class="report-meta">
                                    üïê Cree a  ${report.created_at} ${report.last_edit_at && "- Modifie a"} ${report.last_edit_at} ‚Ä¢ ID: ${report.id} ‚Ä¢ Valid√© : ${dayData.validated ? 'Oui' : 'Non'}</div>
                                <div class="report-content">${contentPreview}${cleanText.length > 100 ? '...' : ''}</div>
                                ${filesHtml}
                                <div class="report-actions">
                                    <button class="btn btn-primary" onclick="openReportView(${report.id}, '${escapedDay}', ${userId})">üëÅÔ∏è Visualiser</button>
                                </div>
                            </div>
                        `;
                            });


                            html += `</div>`;
                        }
                    });

                    html += `</div>`;
                }
            });

            reportsList.innerHTML = html || '<div class="empty-state">Aucun rapport trouv√©.</div>';
            // After inserting HTML, load file previews (images/buttons) where applicable
            attachFilePreviews(reportsList);
        }

        // ===== Edit Report =====
        window.editReport = function (reportId, day, userId) {
            // Find the report - for admin view, search in specific user; for user view, search in allReports.items
            let report = null;

            if (userId !== undefined) {
                // Admin view: report is in allReports[userId].items[day]
                const userData = allReports?.[userId];
                const dayData = userData?.items?.[day];
                report = dayData?.records?.find(r => r.id === reportId);
            } else {
                // User view: report is in allReports.items[day]
                const dayData = allReports?.items?.[day];
                report = dayData?.records?.find(r => r.id === reportId);
            }

            if (report) {
                currentEditingReport = report;
                document.getElementById('editTitle').value = report.title;
                initEditQuill();
                editQuill.root.innerHTML = report.content?.text || '';
                // Populate existing files UI and reset file input
                populateExistingFiles(report);
                // Populate extra fields if present
                populateEditExtraFields(report);
                if (fileInput) fileInput.value = null;
                switchView('edit');
            } else {
                displayStatus('Rapport introuvable', true);
            }
        };

        // Populate existing files into the edit form, with checkboxes to mark for deletion
        function populateExistingFiles(report) {
            const container = document.getElementById('existingFilesContainer');
            if (!container) return;
            container.innerHTML = '';

            const files = report.content?.files || [];
            if (files.length === 0) {
                container.innerHTML = '<div style="font-size:13px;color:#718096">No attachments</div>';
                return;
            }

            files.forEach(f => {
                const rawPath = f.path || f.name || '';
                const subpath = (rawPath || '').replace(/^database\/files[\\/]/i, '').replace(/\\/g, '/');
                const fileId = f.id || f.file_id || f._id || '';
                const wrapper = document.createElement('div');
                wrapper.className = 'existing-file-item';
                wrapper.style.display = 'flex';
                wrapper.style.alignItems = 'center';
                wrapper.style.gap = '8px';

                if ((f.type || '').startsWith('image') || /\.(png|jpg|jpeg|gif|webp|bmp|svg)$/i.test(f.name || '')) {
                    const img = document.createElement('img');
                    img.setAttribute('data-filepath', subpath);
                    img.alt = f.name || '';
                    img.style.width = '72px';
                    img.style.height = '72px';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '6px';
                    img.style.background = '#f0f0f0';
                    wrapper.appendChild(img);
                } else {
                    const a = document.createElement('a');
                    a.className = 'report-file-link';
                    a.setAttribute('data-filepath', subpath);
                    a.href = '#';
                    a.target = '_blank';
                    a.textContent = f.name || subpath;
                    wrapper.appendChild(a);
                }

                const label = document.createElement('label');
                label.style.fontSize = '13px';
                label.style.color = '#4a5568';
                label.style.display = 'flex';
                label.style.alignItems = 'center';
                label.style.gap = '6px';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'file-delete-checkbox';
                // Set data-fileid for deletion
                checkbox.setAttribute('data-fileid', fileId);
                label.appendChild(checkbox);
                const span = document.createElement('span');
                span.textContent = 'Supprimer';
                label.appendChild(span);

                wrapper.appendChild(label);
                container.appendChild(wrapper);
            });

            // Attempt to load previews for any image elements inside the container
            attachFilePreviews(container);
        }

        // Populate extra fields into the edit form
        function populateEditExtraFields(report) {
            const tbody = document.getElementById('editExtraFieldsBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            const extraFields = report.content?.extra_fields || [];
            let fieldCount = 0;
            
            extraFields.forEach(field => {
                const rowId = `edit-field-${fieldCount++}`;
                const row = document.createElement('tr');
                row.id = rowId;
                row.innerHTML = `
                    <td><input type="text" class="extra-field-key" placeholder="ex: Priorit√©" value="${field.key || ''}" /></td>
                    <td><input type="text" class="extra-field-value" placeholder="ex: Haute" value="${field.value || ''}" /></td>
                    <td><button type="button" class="remove-field-btn" onclick="removeEditExtraField('${rowId}')">Supprimer</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        let editExtraFieldCount = 0;

        function addEditExtraField(key = '', value = '') {
            const tbody = document.getElementById('editExtraFieldsBody');
            const rowId = `edit-field-${editExtraFieldCount++}`;
            
            const row = document.createElement('tr');
            row.id = rowId;
            row.innerHTML = `
                <td><input type="text" class="extra-field-key" placeholder="ex: Priorit√©" value="${key}" /></td>
                <td><input type="text" class="extra-field-value" placeholder="ex: Haute" value="${value}" /></td>
                <td><button type="button" class="remove-field-btn" onclick="removeEditExtraField('${rowId}')">Supprimer</button></td>
            `;
            
            tbody.appendChild(row);

            toggleAccordion('edit-extra-fields', 'unfold')
        }

        function removeEditExtraField(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
            }

            toggleAccordion('edit-extra-fields', 'unfold')
        }

        function getEditExtraFields() {
            const rows = document.querySelectorAll('#editExtraFieldsBody tr');
            const fields = [];
            
            rows.forEach(row => {
                const keyInput = row.querySelector('.extra-field-key');
                const valueInput = row.querySelector('.extra-field-value');
                
                if (keyInput && valueInput) {
                    const key = keyInput.value.trim();
                    const value = valueInput.value.trim();
                    
                    // Only add non-empty fields
                    if (key || value) {
                        fields.push({ key, value });
                    }
                }
            });
            
            return fields;
        }


        // ===== Accordion Toggle Function =====
        function toggleAccordion(sectionId, strict_action = "") {
            const content = document.getElementById(sectionId + '-content');
            const icon = document.getElementById(sectionId + '-icon');

            if (strict_action == "fold") {
                // Collapse
                content.style.maxHeight = '0px';
                icon.style.transform = 'rotate(-90deg)';
                if (!content.classList.contains("collapsed")) content.classList.add("collapsed")
                return
            }
            if (strict_action == "unfold") {
                // Expand
                content.style.maxHeight = content.scrollHeight + 'px';
                icon.style.transform = 'rotate(0deg)';
                if (content.classList.contains("collapsed")) content.classList.remove("collapsed")
                return
            }

            if (content.style.maxHeight && content.style.maxHeight !== '0px') {
                // Collapse
                content.style.maxHeight = '0px';
                icon.style.transform = 'rotate(-90deg)';
                if (!content.classList.contains("collapsed")) content.classList.add("collapsed")
            } else {
                // Expand
                content.style.maxHeight = content.scrollHeight + 'px';
                icon.style.transform = 'rotate(0deg)';
                if (content.classList.contains("collapsed")) content.classList.remove("collapsed")
            }
        }

        // ===== Save Edit =====
        document.getElementById('btnSaveEdit').addEventListener('click', async function () {
            if (!currentEditingReport) return;

            const title = document.getElementById('editTitle').value.trim();
            const content = editQuill.root.innerHTML;
            // const date = document.getElementById('editDate').value;

            // if (!title) {
            //     displayStatus('Veuillez saisir un titre', true);
            //     return;
            // }

            const apiKey = getApiKey('reports');
            if (!apiKey) {
                displayStatus('Cl√© API manquante. Veuillez vous reconnecter.', true);
                return;
            }

            const authToken = getAuthToken();

            // Collect new files and deletions
            const newFiles = fileInput ? Array.from(fileInput.files) : [];
            const deleteChecks = Array.from(document.querySelectorAll('.file-delete-checkbox:checked'));

            // Use data-fileid attribute for IDs
            const filesToDelete = deleteChecks.map(cb => cb.getAttribute('data-fileid')).filter(Boolean);

            // Show loading state
            setButtonLoading(document.getElementById('btnSaveEdit'), true);

            try {
                let response;

                // Use multipart/form-data when adding/removing files
                const form = new FormData();
                form.append('id', currentEditingReport.id);
                form.append('date', currentEditingReport.day);
                form.append('title', title);
                // Append text content using 'text' to match upload form style
                form.append('text', content);
                // Add extra_fields as JSON string
                const editExtraFields = getEditExtraFields();
                if (editExtraFields.length > 0) {
                    form.append('extra_fields', JSON.stringify(editExtraFields));
                }
                // Send files_to_delete as JSON array of IDs

                if (filesToDelete.length != 0) {
                    filesToDelete.forEach(f => {
                        form.append('files_to_delete', f);
                    });
                }

                // Joindre les fichiers
                if (selectedFilesData && selectedFilesData.length > 0) {
                    selectedFilesData.forEach((fd, i) => {
                        const blob = dataURLToBlob(fd.data);
                        form.append(`files`, blob, fd.name);
                    });
                }

                const headers = { 'x-api-key': apiKey };
                if (authToken) headers['Authorization'] = 'Bearer ' + authToken;

                // Log FormData entries for debug
                for (const [key, value] of form.entries()) {
                    if (value instanceof Blob) {
                        console.log(`${key}: Blob(name=${value.name || ''}, size=${value.size}, type=${value.type})`);
                    } else {
                        console.log(`${key}:`, value);
                    }
                }

                response = await fetch(getApiUrl(CONFIG.REPORTS_EDIT), {
                    method: 'PATCH',
                    headers: headers,
                    body: form
                });

                if (response.status === 401) {
                    displayStatus('Session expired. Redirecting to login...', true);
                    handleSessionExpiry();
                    return;
                }

                // Attempt to parse JSON only if present; handle empty/non-JSON bodies
                let data = null;
                const contentType = response.headers.get('content-type') || '';
                if (contentType.includes('application/json')) {
                    data = await response.json();
                }

                if (data && typeof data === 'object') {
                    if (data.ok) {
                        displayStatus('‚úÖ Rapport mis √† jour avec succ√®s !');
                        selectedFilesData = [];
                        updatePreview();
                        toggleAccordion('attachments', 'fold')
                        toggleAccordion('edit-content', 'fold')

                        // Effacer les brouillons du localStorage
                        clearDraftData();
                        await fetchReports();
                        switchView('list');
                    } else {
                        displayStatus('√âchec de la mise √† jour du rapport : ' + (data.message || 'Erreur inconnue'), true);
                    }
                } else {
                    // No JSON body; treat 2xx as success, otherwise error
                    if (response.ok) {
                        displayStatus('‚úÖ Rapport mis √† jour avec succ√®s !');
                        selectedFilesData = [];
                        updatePreview();
                        toggleAccordion('attachments', 'fold')
                        toggleAccordion('edit-content', 'fold')

                        // Effacer les brouillons du localStorage
                        clearDraftData();
                        await fetchReports();
                        switchView('list');
                    } else {
                        displayStatus('√âchec de la mise √† jour du rapport : HTTP ' + response.status, true);
                    }
                }
            } catch (error) {
                console.error('Error updating report:', error);
                displayStatus('Erreur lors de la mise √† jour du rapport : ' + error.message, true);
            } finally {
                // Remove loading state when done
                setButtonLoading(document.getElementById('btnSaveEdit'), false);
            }
        });

        // ===== Cancel Edit =====
        document.getElementById('btnCancelEdit').addEventListener('click', function () {
            switchView('list');
        });

        // ===== Delete Report =====
        window.deleteReport = async function (reportId) {
            if (!confirm("√ätes-vous s√ªr de vouloir supprimer ce rapport ?")) {
                return;
            }

            const apiKey = getApiKey('reports');
            if (!apiKey) {
                displayStatus('Cl√© API manquante. Veuillez vous reconnecter.', true);
                return;
            }

            const headers = {
                'accept': 'application/json',
                'x-api-key': apiKey
            };

            const authToken = getAuthToken();
            if (authToken) headers['Authorization'] = 'Bearer ' + authToken;

            try {
                const response = await fetch(getApiUrl(CONFIG.REPORTS_DELETE + '/' + reportId), {
                    method: 'DELETE',
                    headers: headers
                });

                if (response.status === 401) {
                    displayStatus('Session expired. Redirecting to login...', true);
                    handleSessionExpiry();
                    return;
                }

                // Attempt to parse JSON only if present; handle empty/non-JSON bodies
                let data = null;
                const contentTypeDel = response.headers.get('content-type') || '';
                if (contentTypeDel.includes('application/json')) {
                    data = await response.json();
                }

                if (data && typeof data === 'object') {
                    if (data.ok) {
                        displayStatus('‚úÖ Rapport supprim√© avec succ√®s !');
                        await fetchReports();
                    } else {
                        displayStatus('√âchec de la suppression du rapport : ' + (data.message || 'Erreur inconnue'), true);
                    }
                } else {
                    if (response.ok) {
                        displayStatus('‚úÖ Rapport supprim√© avec succ√®s !');
                        await fetchReports();
                    } else {
                        displayStatus('√âchec de la suppression du rapport : HTTP ' + response.status, true);
                    }
                }
            } catch (error) {
                console.error('Error deleting report:', error);
                displayStatus('Erreur lors de la suppression du rapport : ' + error.message, true);
            }
        };

        // ===== Navigation Buttons =====
        btnListView.addEventListener('click', () => switchView('list'));
        if (btnViewReport) btnViewReport.addEventListener('click', () => switchView('visual'));
        btnEditView.addEventListener('click', () => switchView('edit'));

        // ===== Show User Info =====
        const userProfile = getUserProfile();
        displayUserInfo(userInfo, userProfile, tg?.initDataUnsafe?.user);
        if (userProfile.role === "Administrator") {
            document.querySelector("#pageTitle").innerHTML = "Rapports Soumis"
            fetchUsers();
        }

        // ===== Initialize =====
        fetchReports();

        // ===== File Preview Functions =====
        async function openFilePreview(filepath, filename, filetype) {
            const modal = document.getElementById('filePreviewModal');
            const title = document.getElementById('previewTitle');
            const body = document.getElementById('previewBody');
            const downloadBtn = document.getElementById('previewDownloadBtn');

            title.textContent = filename;

            // Construct download URL with auth headers
            const apiKey = getApiKey('reports');
            const authToken = getAuthToken();
            const downloadUrl = getApiUrl('/files/' + encodeURIComponent(filepath));

            let objectUrl;

            try {
                const headers = { 'x-api-key': apiKey };
                if (authToken) headers['Authorization'] = 'Bearer ' + authToken;
                const res = await fetch(downloadUrl, { method: 'GET', headers });
                if (!res.ok) throw new Error('Network response was not ok');
                const blob = await res.blob();
                objectUrl = URL.createObjectURL(blob);
            } catch (err) {
                console.warn('Failed to load file', filepath, err);
            }

            downloadBtn.href = objectUrl;


            downloadBtn.download = filename;

            // Add auth headers to download button via data attributes for fetch fallback
            downloadBtn.setAttribute('data-filepath', filepath);
            downloadBtn.setAttribute('data-filename', filename);
            // downloadBtn.onclick = (e) => {
            //     e.preventDefault();
            //     downloadFileWithAuth(filepath, filename, apiKey, authToken);
            // };

            // Determine preview type
            const isImage = /\.(png|jpg|jpeg|gif|webp|bmp|svg)$/i.test(filename);
            const isAudio = /\.(mp3|wav|ogg|flac|aac|m4a)$/i.test(filename);
            const isVideo = /\.(mp4|webm|ogg|mkv|avi|mov)$/i.test(filename);
            const isPdf = /\.(pdf)$/i.test(filename);

            body.innerHTML = '';

            if (isImage) {
                // Display images directly
                const img = document.createElement('img');
                img.src = objectUrl;
                img.alt = filename;
                img.style.maxWidth = '100%';
                img.style.maxHeight = '60vh';
                img.style.borderRadius = '12px';
                body.appendChild(img);
            } else if (isVideo || isAudio || isPdf) {
                // Display media in iframe for audio, video, and PDF
                const iframe = document.createElement('iframe');
                iframe.src = objectUrl;
                iframe.style.width = '100%';
                iframe.style.height = '60vh';
                iframe.style.borderRadius = '12px';
                iframe.style.border = 'none';
                body.appendChild(iframe);
            } else {
                // Non-previewable file - show filename with extension
                const ext = filename.split('.').pop().toUpperCase();
                body.innerHTML = `
                    <div class="file-not-previewable">
                        <div class="file-not-previewable-icon">üìÑ</div>
                        <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">${filename}</div>
                        <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">
                            <strong>Type:</strong> ${ext} file
                        </div>
                        <div style="font-size: 13px; color: var(--text-secondary);">Ce fichier ne peut pas √™tre pr√©visualis√© en ligne.</div>
                        <div style="font-size: 13px; color: var(--text-secondary); margin-top: 12px;">Cliquez sur le bouton T√©l√©charger ci-dessous pour ouvrir le fichier.</div>
                    </div>
                `;
            }

            modal.classList.add('active');
        }


        // ===== Report View (full report visualization moved to Visual tab) =====
        window.openReportView = function (reportId, day, userId) {
            // find report similar to editReport
            let report = null;
            if (userId !== undefined) {
                const userData = allReports?.[userId];
                const dayData = userData?.items?.[day];
                report = dayData?.records?.find(r => r.id === reportId);
            } else {
                const dayData = allReports?.items?.[day];
                report = dayData?.records?.find(r => r.id === reportId);
            }

            if (!report) {
                displayStatus('Rapport introuvable', true);
                return;
            }

            // Populate the read-only visual tab
            const titleEl = document.getElementById('reportFullTitle');
            const metaEl = document.getElementById('reportFullMeta');
            const contentEl = document.getElementById('reportFullContent');
            const attachmentsEl = document.getElementById('reportFullAttachments');

            titleEl.textContent = report.title || '';
            const timeText = report.time || report.created_at || '';
            metaEl.textContent = `üïê ${timeText} ‚Ä¢ ID: ${report.id}` + (day ? ` ‚Ä¢ Date: ${day}` : '') + (userId !== undefined ? ` ‚Ä¢ User: ${userId}` : '');
            contentEl.innerHTML = report.content?.text || '<div style="color:#718096">(Pas de contenu)</div>';

            attachmentsEl.innerHTML = '';
            const files = report.content?.files || [];
            if (files.length > 0) {
                files.forEach(f => {
                    const rawPath = f.path || f.name || '';
                    const subpath = (rawPath || '').replace(/^files[\\/]/i, '').replace(/\\/g, '/');
                    const isImage = /\.(png|jpg|jpeg|gif|webp|bmp|svg)$/i.test(f.name || '');

                    if (isImage) {
                        const img = document.createElement('img');
                        img.setAttribute('data-filepath', subpath);
                        img.alt = f.name || '';
                        img.style.width = '120px';
                        img.style.height = '120px';
                        img.style.objectFit = 'cover';
                        img.style.borderRadius = '8px';
                        img.style.cursor = 'pointer';
                        img.onclick = () => openFilePreview(subpath, f.name || subpath, f.type || '');
                        attachmentsEl.appendChild(img);
                    } else {
                        const btn = document.createElement('button');
                        btn.className = 'report-file-link';
                        btn.style.cursor = 'pointer';
                        btn.textContent = f.name || subpath;
                        btn.onclick = () => openFilePreview(subpath, f.name || subpath, f.type || '');
                        attachmentsEl.appendChild(btn);
                    }
                });

                // If there's a helper to attach previews, call it (images have data-filepath for lazy loading)
                if (typeof attachFilePreviews === 'function') {
                    try { attachFilePreviews(attachmentsEl); } catch (e) { /* ignore */ }
                }
            }

            // Switch to visual tab
            switchView('visual');
        };

        function closeReportView() {
            // kept for compatibility with modal close handlers; switch back to list
            switchView('list');
        }

        function closeFilePreview() {
            const modal = document.getElementById('filePreviewModal');
            modal.classList.remove('active');
            document.getElementById('previewBody').innerHTML = '';
        }

        // Gestion du changement de fichier
        fileInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files.length > 0) {
                readFiles(e.target.files);
                // R√©initialiser l'input pour permettre la s√©lection du m√™me fichier
                e.target.value = '';
            }
        });

        // Gestion du glisser-d√©poser
        const uploadArea = document.querySelector('.file-upload-area');

        // Click handler for upload area (prevents double-opening)
        uploadArea.addEventListener('click', (e) => {
            // Only trigger file input if not clicking on the file input itself
            if (e.target !== fileInput) {
                fileInput.click();
            }
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.style.borderColor = '#138496';
            uploadArea.style.background = '#e6fcff';
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.style.borderColor = '#17a2b8';
            uploadArea.style.background = '#f0fdff';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.style.borderColor = '#17a2b8';
            uploadArea.style.background = '#f0fdff';

            if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                readFiles(e.dataTransfer.files);
            }
        });


        // Close modal when clicking outside
        document.getElementById('filePreviewModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeFilePreview();
            }
        });

        // ===== Single Report View Functions =====
        
        /**
         * View report detail by ID (from URL parameter or button click)
         */
        async function viewReportDetail(reportId) {
            try {
                const apiKey = getApiKey('reports');
                if (!apiKey) {
                    displayStatus('Cl√© API manquante', true);
                    return;
                }

                const headers = {
                    'accept': 'application/json',
                    'x-api-key': apiKey
                };

                // Fetch single report from API
                const response = await fetch(`/api/reports/single?id=${reportId}`, {
                    method: 'GET',
                    headers: headers
                });

                if (!response.ok) {
                    displayStatus('Rapport introuvable', true);
                    return;
                }

                const data = await response.json();
                if (!data.ok || !data.report) {
                    displayStatus('Erreur lors du chargement du rapport', true);
                    return;
                }

                const report = data.report;
                displaySingleReport(report);
                switchView('singleReport');
            } catch (error) {
                console.error('Error fetching single report:', error);
                displayStatus('Erreur lors du chargement du rapport', true);
            }
        }

        /**
         * Display single report in the dedicated view
         */
        function displaySingleReport(report) {
            const titleEl = document.getElementById('singleReportTitle');
            const metaEl = document.getElementById('singleReportMeta');
            const contentEl = document.getElementById('singleReportContent');
            const attachmentsEl = document.getElementById('singleReportAttachments');
            const extraFieldsEl = document.getElementById('singleReportExtraFields');
            const shareReportBtn = document.getElementById('shareReportBtn');

            // Set title and meta
            titleEl.textContent = report.title || 'Sans titre';
            metaEl.textContent = `üïê Cr√©√© le ${report.created_at}${report.last_edit_at ? ` ‚Ä¢ Modifi√© le ${report.last_edit_at}` : ''} ‚Ä¢ ID: ${report.id} ‚Ä¢ Date: ${report.day}`;

            // Set content
            contentEl.innerHTML = report.content?.text || '<div style="color:#718096">(Pas de contenu)</div>';

            // Display attachments
            attachmentsEl.innerHTML = '';
            const files = report.content?.files || [];
            if (files.length > 0) {
                const filesTitle = document.createElement('div');
                filesTitle.style.fontWeight = '600';
                filesTitle.style.marginBottom = '8px';
                filesTitle.style.color = 'var(--text-primary)';
                filesTitle.textContent = 'üìé Pi√®ces jointes:';
                filesTitle.style.flexBasis = '100%';
                attachmentsEl.appendChild(filesTitle);

                files.forEach(f => {
                    const rawPath = f.path || f.name || '';
                    const subpath = (rawPath || '').replace(/^database\/files[\\/]/i, '').replace(/\\/g, '/');
                    const isImage = /\.(png|jpg|jpeg|gif|webp|bmp|svg)$/i.test(f.name || '');

                    if (isImage) {
                        const img = document.createElement('img');
                        img.setAttribute("data-filepath", `${subpath}`);
                        img.alt = f.name;
                        img.style.width = '80px';
                        img.style.height = '80px';
                        img.style.objectFit = 'cover';
                        img.style.borderRadius = '6px';
                        img.style.background = '#f0f0f0';
                        img.style.cursor = 'pointer';
                        img.onclick = () => openFilePreview(subpath, f.name, f.type);
                        attachmentsEl.appendChild(img);
                    } else {
                        const btn = document.createElement('button');
                        btn.textContent = f.name;
                        btn.style.padding = '8px 12px';
                        btn.style.borderRadius = '10px';
                        btn.style.background = 'var(--bg-white)';
                        btn.style.border = '1px solid var(--border-light)';
                        btn.style.color = 'var(--text-primary)';
                        btn.style.fontWeight = '600';
                        btn.style.fontSize = '13px';
                        btn.style.cursor = 'pointer';
                        btn.onclick = () => openFilePreview(subpath, f.name, f.type);
                        attachmentsEl.appendChild(btn);
                    }
                });
            }

            // Display extra fields if present
            extraFieldsEl.innerHTML = '';
            const extraFields = report.content?.extra_fields || [];
            if (extraFields.length > 0) {
                const extraTitle = document.createElement('div');
                extraTitle.style.fontWeight = '600';
                extraTitle.style.marginBottom = '8px';
                extraTitle.style.color = 'var(--text-primary)';
                extraTitle.textContent = 'üìã Champs suppl√©mentaires:';
                extraFieldsEl.appendChild(extraTitle);

                const fieldsContainer = document.createElement('div');
                fieldsContainer.style.display = 'grid';
                fieldsContainer.style.gridTemplateColumns = 'repeat(auto-fit, minmax(200px, 1fr))';
                fieldsContainer.style.gap = '12px';

                extraFields.forEach(field => {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.style.background = 'var(--bg-light)';
                    fieldDiv.style.padding = '12px';
                    fieldDiv.style.borderRadius = '8px';
                    fieldDiv.style.borderLeft = '4px solid #1890ff';

                    const keyEl = document.createElement('div');
                    keyEl.style.fontWeight = '600';
                    keyEl.style.color = '#1890ff';
                    keyEl.style.fontSize = '12px';
                    keyEl.style.marginBottom = '4px';
                    keyEl.textContent = field.key;

                    const valueEl = document.createElement('div');
                    valueEl.style.color = 'var(--text-primary)';
                    valueEl.style.wordBreak = 'break-word';
                    valueEl.textContent = field.value;

                    fieldDiv.appendChild(keyEl);
                    fieldDiv.appendChild(valueEl);
                    fieldsContainer.appendChild(fieldDiv);
                });

                extraFieldsEl.appendChild(fieldsContainer);
            }

            // Setup share button
            shareReportBtn.onclick = () => shareReport(report.id);

            // Store current report ID for sharing
            window.currentReportId = report.id;
            attachFilePreviews(singleReportView);
        }

        /**
         * Share report by copying link to clipboard
         */
        function shareReport(reportId) {
            const shareUrl = `${window.location.origin}${window.location.pathname}?reportId=${reportId}`;
            
            // Copy to clipboard
            navigator.clipboard.writeText(shareUrl).then(() => {
                displayStatus('Lien copi√© dans le presse-papiers! üìã', false);
            }).catch(() => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = shareUrl;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    displayStatus('Lien copi√© dans le presse-papiers! üìã', false);
                } catch (err) {
                    displayStatus('Erreur lors de la copie du lien', true);
                }
                document.body.removeChild(textarea);
            });
        }

        /**
         * Go back from single report view
         */
        function backFromSingleReport() {
            switchView('list');
        }

        /**
         * Updated switchView to handle singleReport view
         */
        const originalSwitchView = window.switchView;
        window.switchView = function(view) {
            const singleReportView = document.getElementById('singleReportView');
            
            if (view === 'list') {
                listView.classList.add('active');
                editView.classList.remove('active');
                if (viewReportView) viewReportView.classList.remove('active');
                if (singleReportView) singleReportView.classList.remove('active');
                btnListView.classList.add('active');
                if (btnViewReport) btnViewReport.classList.remove('active');
                btnEditView.classList.remove('active');
                btnEditView.style.display = 'none';
            } else if (view === 'edit') {
                listView.classList.remove('active');
                editView.classList.add('active');
                if (viewReportView) viewReportView.classList.remove('active');
                if (singleReportView) singleReportView.classList.remove('active');
                btnListView.classList.remove('active');
                if (btnViewReport) btnViewReport.classList.remove('active');
                btnEditView.classList.add('active');
                btnEditView.style.display = 'block';
                initEditQuill();
            } else if (view === 'visual') {
                listView.classList.remove('active');
                editView.classList.remove('active');
                if (viewReportView) viewReportView.classList.add('active');
                if (singleReportView) singleReportView.classList.remove('active');
                btnListView.classList.remove('active');
                if (btnViewReport) btnViewReport.classList.add('active');
                btnEditView.classList.remove('active');
                btnEditView.style.display = 'none';
            } else if (view === 'singleReport') {
                listView.classList.remove('active');
                editView.classList.remove('active');
                if (viewReportView) viewReportView.classList.remove('active');
                if (singleReportView) singleReportView.classList.add('active');
                btnListView.classList.remove('active');
                if (btnViewReport) btnViewReport.classList.remove('active');
                btnEditView.classList.remove('active');
                btnEditView.style.display = 'none';
            }
        };

        /**
         * Check for report ID in URL parameters on page load
         */
        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const reportId = params.get('reportId');
            
            if (reportId) {
                // Load and display the report
                viewReportDetail(parseInt(reportId));
            }
        }

        // Check URL parameters when page loads
        window.addEventListener('load', checkUrlParams);
        // Also check immediately in case page is already loaded
        if (document.readyState === 'complete') {
            checkUrlParams();
        }
    </script>
</body>

</html>