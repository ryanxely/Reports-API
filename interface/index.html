<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="icon" type="image/png" href="favicon.png" />
    
    <title>√âditeur de Rapport ‚Äî Mini App</title>

    <!-- Quill.js (√©diteur de texte enrichi) -->
    <!-- <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" onerror="this.href='styles/quill.snow.css'" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js" onerror="this.src='js/quill.min.js'"></script> -->
    <link href="styles/quill.snow.css" rel="stylesheet">
    <script src="js/quill.min.js"></script>

    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Chokokutai&display=swap" rel="stylesheet">


    <link rel="stylesheet" href="styles/index.css">
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="title">
                <h1>Nouveau rapport</h1>
                <label for="reportDate">
                    Date: <input type="date" id="reportDate" style="font-family: inherit;">
                </label>
                <p>
                    <script>
                        const formatter = new Intl.DateTimeFormat("en-GB", {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: "numeric",
                            minute: "numeric",
                        });
                        document.getElementById('reportDate').valueAsDate = new Date();
                        // document.write(formatter.format(new Date()))
                    </script>
                </p>
            </div>
            <nav>
                <a href="view.html" class="nav-link">üìã Voir mes rapports</a>
                <a href="profile.html" class="nav-link">üë§ Profil</a>
                <button class="logout-btn" onclick="handleLogout()">üîó D√©connexion</button>
            </nav>
        </div>

        <div class="title-card">
            <input id="title" placeholder="Titre du rapport" required />
        </div>
        
        <div class="editor-card accordion-section">
            <div class="accordion-header" onclick="toggleAccordion('content')">
                <label>‚úçÔ∏è Contenu</label>
                <span class="accordion-icon" id="content-icon" style="transform: rotate(-90deg)">‚ñº</span>
            </div>
            <div class="accordion-content" id="content-content" style="max-height: 0px;">
                <div id="editor"></div>
            </div>
        </div>

        <div class="form-row accordion-section">
            <div class="accordion-header" onclick="toggleAccordion('attachments')">
                <label>üìé Pi√®ces jointes</label>
                <span class="accordion-icon" id="attachments-icon" style="transform: rotate(-90deg)">‚ñº</span>
            </div>
            <div class="accordion-content" id="attachments-content" style="max-height: 0px;">
                <div class="file-upload-area" id="fileUploadArea">
                    <input type="file" id="fileInput"
                        accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar"
                        multiple />
                    <div class="file-upload-text">
                        <strong>Cliquez pour s√©lectionner</strong> ou glissez-d√©posez vos fichiers<br>
                        <small>Images, vid√©os, audio, documents (PDF, Word, Excel, etc.)</small>
                    </div>
                </div>
                <div id="preview" class="preview"></div>
            </div>
        </div>

        <div class="form-row accordion-section">
            <div class="accordion-header" onclick="toggleAccordion('extra-fields')">
                <label>üîñ Champs personnalis√©s</label>
                <span class="accordion-icon" id="extra-fields-icon" style="transform: rotate(-90deg)">‚ñº</span>
            </div>
            <div class="accordion-content" id="extra-fields-content" style="max-height: 0px;">
                <div id="extraFieldsContainer" class="extra-fields-container">
                    <table class="extra-fields-table">
                        <thead>
                            <tr>
                                <th>Cl√©</th>
                                <th>Valeur</th>
                                <th style="width: 60px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="extraFieldsBody">
                            <!-- Extra field rows will be added here -->
                        </tbody>
                    </table>
                    <button type="button" class="add-field-btn" onclick="addExtraField()">+ Ajouter un champ</button>
                </div>
            </div>
        </div>

        <div class="status" id="status"></div>

        <div class="actions">
            <button id="submitBtn" class="primary">‚úì Envoyer le rapport</button>
            <button id="previewBtn" class="secondary" style="display: none;">üëÅ Aper√ßu</button>
        </div>

        <div class="meta" id="meta"></div>
    </div>

    <!-- Script Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script src="config.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/api.js"></script>
    <script src="js/dom-helpers.js"></script>
    <script src="js/file-previews.js"></script>
    <script>
        // ===== V√©rification d'authentification =====
        requireAuth();

        // Gestionnaire de d√©connexion
        window.handleLogout = async function () {
            await logout();
            window.location.href = 'login.html';
        };

        // ===== Configuration de l'application =====
        const REPORTS_API_URL = getApiUrl(CONFIG.REPORTS_ADD);

        // ===== Initialisation de l'√©diteur Quill =====
        const quill = new Quill('#editor', {
            theme: 'snow',
            placeholder: 'R√©digez votre rapport ici...'
        });

        // ===== Telegram WebApp =====
        const tg = window.Telegram.WebApp;
        tg.expand();

        const statusEl = document.getElementById("status");
        const metaEl = document.getElementById("meta");
        const submitBtn = document.getElementById("submitBtn");
        const previewBtn = document.getElementById("previewBtn");
        const fileInput = document.getElementById('fileInput');
        const previewEl = document.getElementById('preview');

        /**
         * Affiche un message de statut
         */
        function showStatus(message, isError = false) {
            statusEl.innerHTML = message;
            statusEl.className = 'status show';
            if (isError) {
                statusEl.classList.add('error');
            } else {
                statusEl.classList.add('success');
            }

            setTimeout(() => {
                statusEl.classList.remove('show');
            }, 5000);
        }

        // ===== Extra Fields Management =====
        let extraFieldCount = 0;

        function addExtraField(key = '', value = '') {
            const tbody = document.getElementById('extraFieldsBody');
            const rowId = `field-${extraFieldCount++}`;
            
            const row = document.createElement('tr');
            row.id = rowId;
            row.innerHTML = `
                <td><input type="text" class="extra-field-key" placeholder="ex: Priorit√©" value="${key}" /></td>
                <td><input type="text" class="extra-field-value" placeholder="ex: Haute" value="${value}" /></td>
                <td><button type="button" class="remove-field-btn" onclick="removeExtraField('${rowId}')">Supprimer</button></td>
            `;
            
            tbody.appendChild(row);
            toggleAccordion('extra-fields', 'unfold')
        }

        function removeExtraField(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
            }
            toggleAccordion('extra-fields', 'unfold')
        }

        function getExtraFields() {
            const rows = document.querySelectorAll('#extraFieldsBody tr');
            const fields = [];
            
            rows.forEach(row => {
                const keyInput = row.querySelector('.extra-field-key');
                const valueInput = row.querySelector('.extra-field-value');
                
                if (keyInput && valueInput) {
                    const key = keyInput.value.trim();
                    const value = valueInput.value.trim();
                    
                    // Only add non-empty fields
                    if (key || value) {
                        fields.push({ key, value });
                    }
                }
            });
            
            return fields;
        }

        // ===== Gestionnaires d'√©v√©nements =====

        // Gestion du changement de fichier
        fileInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files.length > 0) {
                readFiles(e.target.files);
                // R√©initialiser l'input pour permettre la s√©lection du m√™me fichier
                e.target.value = '';
            }
        });

        // Gestion du glisser-d√©poser
        const uploadArea = document.querySelector('.file-upload-area');

        // Click handler for upload area (prevents double-opening)
        uploadArea.addEventListener('click', (e) => {
            // Only trigger file input if not clicking on the file input itself
            if (e.target !== fileInput) {
                fileInput.click();
            }
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.style.borderColor = '#138496';
            uploadArea.style.background = '#e6fcff';
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.style.borderColor = '#17a2b8';
            uploadArea.style.background = '#f0fdff';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.style.borderColor = '#17a2b8';
            uploadArea.style.background = '#f0fdff';

            if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                readFiles(e.dataTransfer.files);
            }
        });


        // // ===== Accordion Toggle Function =====
        // function toggleAccordion(sectionId) {
        //     const content = document.getElementById(sectionId + '-content');
        //     const icon = document.getElementById(sectionId + '-icon');

        //     if (content.style.maxHeight && content.style.maxHeight !== '0px') {
        //         // Collapse
        //         content.style.maxHeight = '0px';
        //         icon.style.transform = 'rotate(-90deg)';
        //     } else {
        //         // Expand
        //         content.style.maxHeight = content.scrollHeight + 'px';
        //         icon.style.transform = 'rotate(0deg)';
        //     }
        // }

        // ===== Accordion Toggle Function =====
        function toggleAccordion(sectionId, strict_action = "") {
            const content = document.getElementById(sectionId + '-content');
            const icon = document.getElementById(sectionId + '-icon');

            if (strict_action == "fold") {
                // Collapse
                content.style.maxHeight = '0px';
                icon.style.transform = 'rotate(-90deg)';
                if (!content.classList.contains("collapsed")) content.classList.add("collapsed")
                return
            }
            if (strict_action == "unfold") {
                // Expand
                content.style.maxHeight = content.scrollHeight + 'px';
                icon.style.transform = 'rotate(0deg)';
                if (content.classList.contains("collapsed")) content.classList.remove("collapsed")
                return
            }

            if (content.style.maxHeight && content.style.maxHeight !== '0px') {
                // Collapse
                content.style.maxHeight = '0px';
                icon.style.transform = 'rotate(-90deg)';
                if (!content.classList.contains("collapsed")) content.classList.add("collapsed")
            } else {
                // Expand
                content.style.maxHeight = content.scrollHeight + 'px';
                icon.style.transform = 'rotate(0deg)';
                if (content.classList.contains("collapsed")) content.classList.remove("collapsed")
            }
        }


        // Afficher les informations utilisateur
        const userProfile = getUserProfile();
        displayUserInfo(metaEl, userProfile, tg.initDataUnsafe?.user);

        // ===== Soumission du rapport =====
        async function submitReport() {
            const title = document.getElementById("title").value.trim();
            const content_html = quill.root.innerHTML;
            const reportDate = document.getElementById("reportDate").value;
            const extraFields = getExtraFields();

            if (!title && quill.getLength() <= 1) {
                showStatus("Veuillez entrer un titre ou du contenu.", true);
                return;
            }

            // Construire FormData avec le contenu et les fichiers
            const formData = new FormData();
            formData.append("title", title);
            formData.append("text", content_html);
            formData.append("date", reportDate);
            
            // Add extra_fields as JSON string
            if (extraFields.length > 0) {
                formData.append("extra_fields", JSON.stringify(extraFields));
            }

            // Joindre les fichiers
            if (selectedFilesData && selectedFilesData.length > 0) {
                selectedFilesData.forEach((fd, i) => {
                    const blob = dataURLToBlob(fd.data);
                    formData.append(`files`, blob, fd.name);
                });
            }

            showStatus("Envoi du rapport au serveur...");

            try {
                // R√©soudre la cl√© API
                const apiKey = getApiKey('reports');
                if (!apiKey) {
                    showStatus('Cl√© API manquante. Veuillez vous connecter ou configurer la cl√©.', true);
                    return;
                }

                // Construire les en-t√™tes
                const headers = {
                    'accept': 'application/json',
                    'x-api-key': apiKey
                };

                // Inclure le token d'authentification si disponible
                const authToken = getAuthToken();
                if (authToken) headers['Authorization'] = 'Bearer ' + authToken;

                const res = await fetch(REPORTS_API_URL, {
                    method: "POST",
                    headers: headers,
                    body: formData
                });

                if (res.status === 401) {
                    showStatus('Session expir√©e. Redirection vers la connexion...', true);
                    handleSessionExpiry();
                    return;
                }

                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(`Erreur serveur ${res.status}: ${txt}`);
                }

                const json = await res.json();
                if (json && json.ok) {
                    showStatus(`‚úÖ Rapport soumis avec succ√®s. <b><a href='http://localhost/view.html?reportId=${json.report?.id}'>Voir le rapport</a></b>`);

                    // R√©initialiser le formulaire
                    document.getElementById("title").value = "";
                    quill.setContents([]);
                    selectedFilesData = [];
                    updatePreview();
                    document.getElementById('extraFieldsBody').innerHTML = '';

                    // Effacer les brouillons du localStorage
                    clearDraftData();

                    // Informer le bot
                    try {
                        tg.sendData(JSON.stringify({ type: "report_submitted", title, report: json.report }));
                    } catch (err) {
                        console.warn("sendData √©chou√©", err);
                    }
                } else {
                    throw new Error(json?.message || 'R√©ponse serveur inconnue');
                }
            } catch (err) {
                console.error(err);
                showStatus("‚ùå √âchec de la soumission du rapport: " + err.message, true);
            }
        }

        submitBtn.addEventListener("click", submitReport);

        // Pr√©visualisation HTML
        previewBtn.addEventListener("click", () => {
            const html = quill.root.innerHTML;
            const win = window.open("", "_blank");
            win.document.write("<title>Aper√ßu</title>" + html);
            win.document.close();
        });

        // Sauvegarde automatique toutes les 10 secondes
        setInterval(() => {
            setDraftData(document.getElementById("title").value, quill.root.innerHTML);
        }, 10000);

        // Charger le brouillon s'il existe
        const draft = getDraftData();
        if (draft.title) document.getElementById("title").value = draft.title;
        if (draft.content) quill.root.innerHTML = draft.content;
    </script>
</body>

</html>