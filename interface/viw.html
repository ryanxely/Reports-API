<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Mes rapports ‚Äî Mini App</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Chokokutai&display=swap" rel="stylesheet">


    <!-- Quill.js (rich text editor) -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

    <link rel="stylesheet" href="./styles/utils.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #00BFA5;
            --primary-dark: #009688;
            --primary-light: #B2EBE0;
            --bg-light: #F8FAFB;
            --bg-white: #FFFFFF;
            --text-primary: #1A202C;
            --text-secondary: #718096;
            --border-light: #E2E8F0;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 12px 32px rgba(0, 0, 0, 0.12);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #F8FAFB 0%, #F0F9FF 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: var(--bg-white);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
        }

        .header h1 {
            font-family: 'Poppins', sans-serif;
            font-family: "Chokokutai", system-ui;
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
        }

        .nav-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .nav-buttons button {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-white);
            color: var(--text-secondary);
            min-width: 140px;
            letter-spacing: 0.3px;
        }

        .nav-buttons button.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 8px 24px rgba(0, 191, 165, 0.35);
        }

        .nav-buttons button:hover:not(.active) {
            background: var(--bg-light);
            border-color: #D1D5DB;
            transform: translateY(-2px);
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* List View Styles */
        .reports-grid {
            display: grid;
            gap: 20px;
        }

        .day-section {
            background: var(--bg-white);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-sm);
        }

        .day-header {
            font-family: 'Poppins', sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-light);
            letter-spacing: 0.3px;
        }

        .report-card {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .report-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 191, 165, 0.15);
            background: var(--bg-white);
        }

        .report-card:last-child {
            margin-bottom: 0;
        }

        .report-title {
            font-family: 'Poppins', sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            letter-spacing: -0.3px;
        }

        .report-meta {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-weight: 500;
        }

        .report-content {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.6;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Files grid for reports */
        .report-files {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .report-file-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 10px;
            background: var(--bg-white);
            border: 1px solid var(--border-light);
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 600;
            font-size: 13px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .report-file-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0, 191, 165, 0.12);
            border-color: var(--primary);
            color: var(--primary);
        }

        .report-file-icon {
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(0, 191, 165, 0.1), rgba(0, 191, 165, 0.05));
            color: var(--primary);
            font-weight: 700;
            font-size: 12px;
        }

        .report-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.3px;
        }

        .btn-edit {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            flex: 1;
        }

        .btn-edit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0, 191, 165, 0.25);
        }

        .btn-delete {
            background: #FEE2E2;
            color: #EF4444;
            flex: 1;
        }

        .btn-delete:hover {
            background: #FECACA;
            transform: translateY(-2px);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state p {
            font-size: 16px;
            margin-bottom: 12px;
        }

        /* Edit Form */
        .edit-form {
            background: var(--bg-white);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-sm);
        }

        .edit-form h2 {
            font-family: 'Poppins', sans-serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            letter-spacing: -0.5px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            color: var(--text-primary);
            margin-bottom: 10px;
            letter-spacing: 0.3px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            background: var(--bg-white);
            color: var(--text-primary);
        }

        .form-group input:hover {
            border-color: #D1D5DB;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 191, 165, 0.1);
        }

        .form-group input::placeholder {
            color: #A0AEC0;
        }

        #editEditor {
            min-height: 300px;
        }

        .ql-container {
            font-family: 'Inter', sans-serif !important;
            border: 2px solid var(--border-light) !important;
            border-radius: 12px !important;
        }

        .ql-editor {
            padding: 16px !important;
            font-size: 15px !important;
            line-height: 1.6 !important;
        }

        .ql-toolbar {
            border-radius: 12px 12px 0 0 !important;
            border: 2px solid var(--border-light) !important;
            border-bottom: none !important;
            background: var(--bg-light) !important;
        }

        .ql-toolbar button:hover,
        .ql-toolbar button.ql-active {
            color: var(--primary) !important;
        }

        #existingFilesContainer {
            margin-bottom: 16px;
            padding: 16px;
            background: var(--bg-light);
            border-radius: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }

        .existing-file-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-white);
            padding: 8px;
            border-radius: 10px;
            border: 1px solid var(--border-light);
        }

        .existing-file-item img {
            width: 72px;
            height: 72px;
            object-fit: cover;
            border-radius: 8px;
        }

        .file-delete-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        #editFilesInput {
            display: block;
            width: 100%;
            padding: 12px 14px;
            border: 2px dashed var(--primary);
            border-radius: 12px;
            background: rgba(0, 191, 165, 0.02);
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        #editFilesInput:hover {
            background: rgba(0, 191, 165, 0.05);
            border-color: var(--primary-dark);
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-primary {
            flex: 1;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.3px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 191, 165, 0.35);
        }

        .btn-secondary {
            flex: 1;
            padding: 14px;
            background: var(--bg-light);
            color: var(--text-secondary);
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.3px;
        }

        .btn-secondary:hover {
            background: var(--border-light);
            border-color: #D1D5DB;
            transform: translateY(-2px);
        }

        .status {
            margin-top: 16px;
            padding: 14px 16px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status.success {
            background: #DCFCE7;
            color: #166534;
            border: 1px solid #86EFAC;
            display: block;
        }

        .status.error {
            background: #FEE2E2;
            color: #991B1B;
            border: 1px solid #FECACA;
            display: block;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Admin view user header */
        .user-section-header {
            background: linear-gradient(135deg, rgba(0, 191, 165, 0.05), rgba(0, 191, 165, 0.02));
            padding: 16px;
            margin-bottom: 16px;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
        }

        .user-section-header .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--bg-white);
        }

        .user-section-header .user-info {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            color: var(--text-primary);
        }

        .user-section-header .user-detail {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        @media (max-width: 600px) {
            body {
                padding: 12px;
            }

            .header {
                padding: 16px;
            }

            .nav-buttons {
                gap: 8px;
            }

            .nav-buttons button {
                font-size: 13px;
                padding: 10px 12px;
                min-width: 100px;
            }

            .reports-grid {
                gap: 16px;
            }

            .day-section {
                padding: 16px;
            }

            .report-card {
                padding: 12px;
            }

            .form-actions {
                flex-direction: column;
            }

            #editEditor {
                min-height: 200px;
            }
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
        }

        .btn-edit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.4);
        }

        .btn-delete {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
            color: white;
        }

        .btn-delete:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 101, 101, 0.4);
        }

        /* Edit View Styles */
        .edit-form {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #editEditor {
            height: 300px;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
        }

        .btn-primary {
            flex: 1;
            padding: 14px;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            font-size: 16px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
        }

        .btn-secondary {
            flex: 1;
            padding: 14px;
            background: #e2e8f0;
            color: #4a5568;
            font-size: 16px;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
            transform: translateY(-2px);
        }

        /* Loading & Empty States */
        .loading,
        .empty-state {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 60px 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .loading {
            font-size: 16px;
            color: #718096;
        }

        .empty-state {
            font-size: 16px;
            color: #a0aec0;
        }

        .empty-state::before {
            content: "üìù";
            display: block;
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Status Messages */
        .status {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            font-size: 14px;
            font-weight: 600;
            display: none;
        }

        .status.success {
            background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%);
            color: #22543d;
            display: block;
        }

        .status.error {
            background: linear-gradient(135deg, #fed7d7 0%, #fc8181 100%);
            color: #742a2a;
            display: block;
        }

        /* Back to Create Link */
        .back-link {
            display: inline-block;
            margin-bottom: 16px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .logout-btn {
            display: inline-block;
            margin-bottom: 16px;
            margin-left: 8px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #e53e3e;
            text-decoration: none;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* File Preview Modal */
        .file-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .file-preview-modal.active {
            display: flex;
        }

        .file-preview-content {
            background: var(--bg-white);
            border-radius: 16px;
            padding: 24px;
            max-width: 90%;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .file-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-light);
        }

        .file-preview-title {
            font-family: 'Poppins', sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            word-break: break-all;
        }

        .file-preview-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .file-preview-close:hover {
            color: var(--text-primary);
        }

        .file-preview-body {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        .file-preview-body img {
            max-width: 100%;
            max-height: 60vh;
            border-radius: 12px;
        }

        .file-preview-body iframe {
            width: 100%;
            height: 60vh;
            border-radius: 12px;
            border: none;
        }

        .file-preview-body .file-not-previewable {
            text-align: center;
            color: var(--text-secondary);
            padding: 40px;
        }

        .file-preview-body .file-not-previewable-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .file-preview-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .file-preview-download {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .file-preview-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0, 191, 165, 0.25);
        }

        @media (max-width: 600px) {
            .file-preview-content {
                max-width: 95%;
                padding: 16px;
            }

            .file-preview-body iframe {
                height: 40vh;
            }

            .file-preview-body img {
                max-height: 40vh;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div>
            <a href="index.html" class="back-link">‚Üê Cr√©er un rapport</a>
            <a href="profile.html" class="back-link">üë§ Profil</a>
            <button class="logout-btn" onclick="handleLogout()">üö™ D√©connexion</button>
        </div>

        <div class="header">
            <h1>Mes rapports</h1>
            <p id="userInfo">Chargement...</p>
        </div>

        <div class="nav-buttons">
            <button id="btnListView" class="active">üìã Tous les rapports</button>
            <button id="btnViewReport" style="display: none;">üëÅÔ∏è Visualiser le rapport</button>
            <button id="btnEditView" style="display: none;">‚úèÔ∏è Modifier le rapport</button>
        </div>

        <div id="statusMessage" class="status"></div>

        <!-- List View -->
        <div id="listView" class="view active">
            <div id="reportsList" class="reports-grid">
                <div class="loading">Chargement de vos rapports...</div>
            </div>
        </div>

        <!-- Edit View -->
        <div id="editView" class="view">
            <div class="edit-form">
                <h2 style="margin-bottom: 20px; color: #2d3748;">Modifier le rapport</h2>
                <div class="form-group">
                    <label for="editTitle">Title</label>
                    <input type="text" id="editTitle" placeholder="Titre du rapport">
                </div>
                <div class="form-group">
                    <label>Content</label>
                    <div id="editEditor"></div>
                </div>
                <div class="form-group">
                    <label>Pi√®ces jointes</label>
                    <div id="existingFilesContainer" style="margin-bottom:8px; display:flex; gap:8px; flex-wrap:wrap;">
                    </div>
                    <input type="file" id="editFilesInput" multiple
                        accept="image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,audio/*,video/*">
                    <div style="font-size:12px;color:#718096;margin-top:6px;">Pris en charge : images, PDF, DOCX, audio,
                        vid√©o. Cochez les √©l√©ments √† supprimer avant d'enregistrer.</div>
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" id="btnSaveEdit">
                        <span>üíæ Enregistrerr</span>
                        <div class="loading-spinner"></div>
                    </button>

                    <button class="btn btn-secondary" id="btnCancelEdit">Annuler</button>
                </div>
            </div>
        </div>
        <!-- Visualize View (admin) -->
        <div id="viewReport" class="view">
            <div class="edit-form">
                <h2 style="margin-bottom: 12px; color: #2d3748;">Visualisation du rapport</h2>
                <div id="reportFullTitle" style="font-size:20px;font-weight:700;margin-bottom:8px;color:var(--text-primary);"></div>
                <div id="reportFullMeta" style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;"></div>
                <div id="reportFullContent" style="background:var(--bg-light);padding:16px;border-radius:10px;width:100%;margin-bottom:12px;color:var(--text-secondary);">
                </div>
                <div id="reportFullAttachments" style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;"></div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="switchView('list')">Retour</button>
                </div>
            </div>
        </div>
    </div>

    <!-- File Preview Modal -->
    <div id="filePreviewModal" class="file-preview-modal">
        <div class="file-preview-content">
            <div class="file-preview-header">
                <div class="file-preview-title" id="previewTitle">Aper√ßu du fichier</div>
                <button class="file-preview-close" onclick="closeFilePreview()">&times;</button>
            </div>
            <div class="file-preview-body" id="previewBody">
                <!-- Content will be injected here -->

            </div>
            <div class="file-preview-actions">
                <a id="previewDownloadBtn" class="file-preview-download" download>‚¨áÔ∏è T√©l√©charger</a>
            </div>
        </div>
    </div>

    <!-- (removed unused modal; admin visualizer now uses the Visualize tab) -->

    <!-- Telegram Web App script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script src="config.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/api.js"></script>
    <script src="js/dom-helpers.js"></script>
    <script src="js/file-previews.js"></script>
    <script>
        // ===== Auth Check =====
        //requireAuth();

        // Logout handler4666
        window.handleLogout = function () {
            logout();
            window.location.href = 'login.html';
        };

        // ===== Configuration =====
        const REPORTS_API_URL = getApiUrl(CONFIG.REPORTS_GET);

        // ===== Telegram WebApp =====
        const tg = window.Telegram.WebApp;
        tg.expand();

        // ===== State Management =====
        let currentView = 'list';
        let currentEditingReport = null;
        let allReports = [];
        let editQuill = null;

        // ===== DOM Elements =====
        const listView = document.getElementById('listView');
        const editView = document.getElementById('editView');
        const viewReportView = document.getElementById('viewReport');
        const btnListView = document.getElementById('btnListView');
        const btnViewReport = document.getElementById('btnViewReport');
        const btnEditView = document.getElementById('btnEditView');
        const reportsList = document.getElementById('reportsList');
        const statusMessage = document.getElementById('statusMessage');
        const userInfo = document.getElementById('userInfo');

        // ===== Initialize Quill for Edit View =====
        function initEditQuill() {
            if (!editQuill) {
                editQuill = new Quill('#editEditor', {
                    theme: 'snow',
                    placeholder: 'Modifiez le contenu de votre rapport...'
                });
            }
        }

        // ===== Show Status Message =====
        // Use the showStatus from dom-helpers.js - adapt for this custom element
        function displayStatus(message, isError = false) {
            statusMessage.innerText = message;
            statusMessage.className = isError ? 'status error' : 'status success';
            setTimeout(() => {
                statusMessage.className = 'status';
            }, 5000);
        }

        // ===== Switch Views =====
        function switchView(view) {
            currentView = view;

            if (view === 'list') {
                listView.classList.add('active');
                editView.classList.remove('active');
                if (viewReportView) viewReportView.classList.remove('active');
                btnListView.classList.add('active');
                if (btnViewReport) btnViewReport.classList.remove('active');
                btnEditView.classList.remove('active');
                btnEditView.style.display = 'none';
            } else if (view === 'edit') {
                listView.classList.remove('active');
                editView.classList.add('active');
                if (viewReportView) viewReportView.classList.remove('active');
                btnListView.classList.remove('active');
                if (btnViewReport) btnViewReport.classList.remove('active');
                btnEditView.classList.add('active');
                btnEditView.style.display = 'block';
                initEditQuill();
            } else if (view === 'visual') {
                // show the admin visualize tab
                listView.classList.remove('active');
                editView.classList.remove('active');
                if (viewReportView) viewReportView.classList.add('active');
                btnListView.classList.remove('active');
                if (btnViewReport) btnViewReport.classList.add('active');
                btnEditView.classList.remove('active');
                btnEditView.style.display = 'none';
            }
        }

        // ===== Fetch Reports =====
        async function fetchReports() {
            try {
                const apiKey = getApiKey('reports');
                if (!apiKey) {
                    displayStatus('Cl√© API des rapports manquante. Veuillez vous reconnecter.', true);
                    reportsList.innerHTML = '<div class="empty-state">Cl√© API manquante. Veuillez <a href="login.html">vous reconnecter</a>.</div>';
                    return;
                }

                const headers = {
                    'accept': 'application/json',
                    'x-api-key': apiKey
                };

                const authToken = getAuthToken();
                if (authToken) headers['Authorization'] = 'Bearer ' + authToken;

                const response = await fetch(REPORTS_API_URL, {
                    method: 'GET',
                    headers: headers
                });



                if (response.status === 401) {
                    // session expired
                    displayStatus('Session expir√©e. Redirection vers la page de connexion...', true);
                    handleSessionExpiry();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                console.log('Fetch reports response:', data);
                if (data.ok && data.reports) {
                    allReports = data.reports;
                    renderReports();
                } else {
                    displayStatus('Impossible de charger les rapports', true);
                }
            } catch (error) {
                console.error('Error fetching reports:', error);
                displayStatus('Erreur lors du chargement des rapports : ' + error.message, true);
                reportsList.innerHTML = '<div class="empty-state">√âchec du chargement des rapports. Veuillez r√©essayer.</div>';
            }
        }

        // ===== Render Reports =====
        function renderReports() {
            // Get logged-in user to check if admin


            const user = getUserProfile();
            const userIsAdmin = user && user.role === 'Administrator';

            // Show the Visualiser tab for admins
            if (btnViewReport) btnViewReport.style.display = userIsAdmin ? 'block' : 'none';

            if (userIsAdmin) {
                // Admin view: show all users' reports grouped by user, then by date
                renderAdminView();
            } else {
                // Regular user view: show only their own reports
                renderUserView();
            }
        }

        function renderUserView() {
            // For regular users, allReports is { items: { dates... }, user_id: X }
            // For admins, allReports is { "0": { items, user_id }, "1": { items, user_id }, ... }
            // This function handles the regular user structure

            const items = allReports?.items || {};
            const dayKeys = Object.keys(items);

            if (dayKeys.length === 0) {
                reportsList.innerHTML = '<div class="empty-state">Aucun rapport pour le moment. Cr√©ez votre premier rapport !</div>';
                return;
            }

            let html = '';

            // Sort days in descending order
            const sortedDays = dayKeys.sort((a, b) => {
                const dateA = new Date(a.split('-').reverse().join('-'));
                const dateB = new Date(b.split('-').reverse().join('-'));
                return dateB - dateA;
            });

            sortedDays.forEach(day => {
                const dayData = items[day];
                const records = dayData.records || [];

                console.log(`Rendering reports for day ${day}:`, records);

                if (records.length > 0) {
                    html += `<div class="day-section">
                        <div class="day-header">üìÖ ${day}</div>`;

                    records.forEach(report => {
                        const contentText = report.content?.text || 'Aucun contenu';
                        const cleanText = String(contentText).replace(/<[^>]*>/g, '');
                        const contentPreview = cleanText.substring(0, 100);

                        // Prepare files markup placeholders; actual file blobs will be fetched and rendered after DOM insert
                        let filesHtml = '';
                        const files = report.content?.files || [];
                        if (files.length > 0) {
                            filesHtml += '<div class="report-files" style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">';
                            files.forEach(f => {
                                // Normalize stored path to subpath used by files endpoint (remove leading 'files\\' or 'files/')
                                const rawPath = f.path || f.name || '';
                                const subpath = (rawPath || '').replace(/^files[\\/]/i, '').replace(/\\/g, '/');
                                const isImage = /\.(png|jpg|jpeg|gif|webp|bmp|svg)$/i.test(f.name || '');

                                // Escape single quotes for use in onclick attribute
                                const escapedSubpath = subpath.replace(/'/g, "\\'");
                                const escapedName = (f.name || '').replace(/'/g, "\\'");
                                const escapedType = (f.type || '').replace(/'/g, "\\'");

                                if (isImage) {
                                    filesHtml += `<img data-filepath="${subpath}" alt="${f.name}" style="width:80px;height:80px;object-fit:cover;border-radius:6px;background:#f0f0f0;cursor:pointer;" onclick="openFilePreview('${escapedSubpath}', '${escapedName}', '${escapedType}')" />`;
                                } else {
                                    filesHtml += `<button style="padding:8px 12px;border-radius:10px;background:var(--bg-white);border:1px solid var(--border-light);color:var(--text-primary);text-decoration:none;font-weight:600;font-size:13px;box-shadow:var(--shadow-sm);transition:all 0.3s ease;cursor:pointer;" onclick="openFilePreview('${escapedSubpath}', '${escapedName}', '${escapedType}')">${f.name}</button>`;
                                }
                            });
                            filesHtml += '</div>';
                        }

                        html += `
                            <div class="report-card">
                                <div class="report-title">${report.title}</div>
                                <div class="report-meta">üïê Cree a  ${report.created_at} ${report.last_edit_at && "- Modifie a"} ${report.last_edit_at} ‚Ä¢ ID: ${report.id}</div>
                                <div class="report-content">${contentPreview}${cleanText.length > 100 ? '...' : ''}</div>
                                ${filesHtml}
                                <div class="report-actions">
                                    <button class="btn btn-edit" onclick="editReport(${report.id}, '${day}')">‚úèÔ∏è Modifier</button>
                                    <button class="btn btn-delete" onclick="deleteReport(${report.id})">üóëÔ∏è Supprimer</button>
                                </div>
                            </div>
                        `;
                    });

                    html += `</div>`;
                }
            });

            reportsList.innerHTML = html || '<div class="empty-state">Aucun rapport trouv√©.</div>';
            // After inserting HTML, attempt to load file blobs for images and set links
            attachFilePreviews(reportsList);
        }


        function renderAdminView() {
            // Admin view: allReports is { "1": { items, user_id }, "2": { items, user_id }, ... }
            const reportsObj = allReports || {};
            const userIds = Object.keys(reportsObj).filter(key => !isNaN(key)).sort((a, b) => parseInt(a) - parseInt(b));

            if (userIds.length === 0) {
                reportsList.innerHTML = '<div class="empty-state">Aucun rapport pour le moment.</div>';
                return;
            }

            let html = '';

            userIds.forEach(userId => {
                const userData = reportsObj[userId];
                const items = userData?.items || {};
                const dayKeys = Object.keys(items);

                if (dayKeys.length > 0) {
                    // User section header
                    const username = `User ${userId}`;
                    const avatarHtml = `<div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; margin-right: 12px; font-size: 14px;">${username.charAt(0).toUpperCase()}</div>`;

                    html += `<div style="background: rgba(102, 126, 234, 0.1); padding: 16px; margin-bottom: 16px; border-radius: 12px; border-left: 4px solid #667eea;">
                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                    ${avatarHtml}
                    <div>
                        <div style="font-size: 16px; font-weight: 700; color: #2d3748;">üë§ ${username}</div>
                        <div style="font-size: 13px; color: #718096;">ID: ${userId}</div>
                    </div>
                </div>`;

                    // Sort days in descending order
                    const sortedDays = dayKeys.sort((a, b) => {
                        const dateA = new Date(a.split('-').reverse().join('-'));
                        const dateB = new Date(b.split('-').reverse().join('-'));
                        return dateB - dateA;
                    });

                    sortedDays.forEach(day => {
                        const dayData = items[day];
                        const records = dayData?.records || [];

                        if (records.length > 0) {
                            html += `<div class="day-section" style="margin-top: 12px;">
                        <div class="day-header">üìÖ ${day}</div>`;

                            records.forEach(report => {
                                // Handle null or empty content text properly
                                const contentText = report.content?.text || 'Aucun contenu';
                                const cleanText = String(contentText).replace(/<[^>]*>/g, '');
                                const contentPreview = cleanText.substring(0, 100);

                                // Escape quotes for onclick attributes
                                const escapedDay = String(day).replace(/'/g, "\\'");

                                // Prepare files markup with preview modal
                                let filesHtml = '';
                                const files = report.content?.files || [];
                                if (files.length > 0) {
                                    filesHtml += '<div class="report-files" style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">';
                                    files.forEach(f => {
                                        const rawPath = f.path || f.name || '';
                                        const subpath = (rawPath || '').replace(/^files[\\/]/i, '').replace(/\\/g, '/');
                                        const isImage = /\.(png|jpg|jpeg|gif|webp|bmp|svg)$/i.test(f.name || '');

                                        // Escape single quotes for use in onclick attribute
                                        const escapedSubpath = subpath.replace(/'/g, "\\'");
                                        const escapedName = (f.name || '').replace(/'/g, "\\'");
                                        const escapedType = (f.type || '').replace(/'/g, "\\'");

                                        if (isImage) {
                                            filesHtml += `<img data-filepath="${subpath}" alt="${f.name}" style="width:80px;height:80px;object-fit:cover;border-radius:6px;background:#f0f0f0;cursor:pointer;" onclick="openFilePreview('${escapedSubpath}', '${escapedName}', '${escapedType}')" />`;
                                        } else {
                                            filesHtml += `<button style="padding:8px 12px;border-radius:10px;background:var(--bg-white);border:1px solid var(--border-light);color:var(--text-primary);text-decoration:none;font-weight:600;font-size:13px;box-shadow:var(--shadow-sm);transition:all 0.3s ease;cursor:pointer;" onclick="openFilePreview('${escapedSubpath}', '${escapedName}', '${escapedType}')">${f.name}</button>`;
                                        }
                                    });
                                    filesHtml += '</div>';
                                }

                                html += `
                            <div class="report-card">
                                <div class="report-title">${report.title}</div>
                                <div class="report-meta">üïê ${report.time} ‚Ä¢ ID: ${report.id} ‚Ä¢ Valid√© : ${dayData.validated ? 'Oui' : 'Non'}</div>
                                <div class="report-content">${contentPreview}${cleanText.length > 100 ? '...' : ''}</div>
                                ${filesHtml}
                                <div class="report-actions">
                                    <button class="btn btn-primary" onclick="openReportView(${report.id}, '${escapedDay}', ${userId})">üëÅÔ∏è Visualiser</button>
                                </div>
                            </div>
                        `;
                            });


                            html += `</div>`;
                        }
                    });

                    html += `</div>`;
                }
            });

            reportsList.innerHTML = html || '<div class="empty-state">Aucun rapport trouv√©.</div>';
            // After inserting HTML, load file previews (images/buttons) where applicable
            attachFilePreviews(reportsList);
        }

        // ===== Edit Report =====
        window.editReport = function (reportId, day, userId) {
            // Find the report - for admin view, search in specific user; for user view, search in allReports.items
            let report = null;

            if (userId !== undefined) {
                // Admin view: report is in allReports[userId].items[day]
                const userData = allReports?.[userId];
                const dayData = userData?.items?.[day];
                report = dayData?.records?.find(r => r.id === reportId);
            } else {
                // User view: report is in allReports.items[day]
                const dayData = allReports?.items?.[day];
                report = dayData?.records?.find(r => r.id === reportId);
            }

            if (report) {
                currentEditingReport = report;
                document.getElementById('editTitle').value = report.title;
                initEditQuill();
                editQuill.root.innerHTML = report.content?.text || '';
                // Populate existing files UI and reset file input
                populateExistingFiles(report);
                const fi = document.getElementById('editFilesInput');
                if (fi) fi.value = null;
                switchView('edit');
            } else {
                displayStatus('Rapport introuvable', true);
            }
        };

        // Populate existing files into the edit form, with checkboxes to mark for deletion
        function populateExistingFiles(report) {
            const container = document.getElementById('existingFilesContainer');
            if (!container) return;
            container.innerHTML = '';

            const files = report.content?.files || [];
            if (files.length === 0) {
                container.innerHTML = '<div style="font-size:13px;color:#718096">No attachments</div>';
                return;
            }

            files.forEach(f => {
                const rawPath = f.path || f.name || '';
                const subpath = (rawPath || '').replace(/^files[\\/]/i, '').replace(/\\/g, '/');
                const fileId = f.id || f.file_id || f._id || '';
                const wrapper = document.createElement('div');
                wrapper.className = 'existing-file-item';
                wrapper.style.display = 'flex';
                wrapper.style.alignItems = 'center';
                wrapper.style.gap = '8px';

                if ((f.type || '').startsWith('image') || /\.(png|jpg|jpeg|gif|webp|bmp|svg)$/i.test(f.name || '')) {
                    const img = document.createElement('img');
                    img.setAttribute('data-filepath', subpath);
                    img.alt = f.name || '';
                    img.style.width = '72px';
                    img.style.height = '72px';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '6px';
                    img.style.background = '#f0f0f0';
                    wrapper.appendChild(img);
                } else {
                    const a = document.createElement('a');
                    a.className = 'report-file-link';
                    a.setAttribute('data-filepath', subpath);
                    a.href = '#';
                    a.target = '_blank';
                    a.textContent = f.name || subpath;
                    wrapper.appendChild(a);
                }

                const label = document.createElement('label');
                label.style.fontSize = '13px';
                label.style.color = '#4a5568';
                label.style.display = 'flex';
                label.style.alignItems = 'center';
                label.style.gap = '6px';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'file-delete-checkbox';
                // Set data-fileid for deletion
                checkbox.setAttribute('data-fileid', fileId);
                label.appendChild(checkbox);
                const span = document.createElement('span');
                span.textContent = 'Supprimer';
                label.appendChild(span);

                wrapper.appendChild(label);
                container.appendChild(wrapper);
            });

            // Attempt to load previews for any image elements inside the container
            attachFilePreviews(container);
        }

        // ===== Save Edit =====
        document.getElementById('btnSaveEdit').addEventListener('click', async function () {
            if (!currentEditingReport) return;

            const title = document.getElementById('editTitle').value.trim();
            const content = editQuill.root.innerHTML;

            if (!title) {
                displayStatus('Veuillez saisir un titre', true);
                return;
            }

            const apiKey = getApiKey('reports');
            if (!apiKey) {
                displayStatus('Cl√© API manquante. Veuillez vous reconnecter.', true);
                return;
            }

            const authToken = getAuthToken();

            // Collect new files and deletions
            const filesInput = document.getElementById('editFilesInput');
            const newFiles = filesInput ? Array.from(filesInput.files) : [];
            const deleteChecks = Array.from(document.querySelectorAll('.file-delete-checkbox:checked'));

            // Use data-fileid attribute for IDs
            const filesToDelete = deleteChecks.map(cb => cb.getAttribute('data-fileid')).filter(Boolean);

            // Show loading state
            setButtonLoading(document.getElementById('btnSaveEdit'), true);

            try {
                let response;

                // Use multipart/form-data when adding/removing files
                const form = new FormData();
                form.append('id', currentEditingReport.id);
                form.append('title', title);
                // Append text content using 'text' to match upload form style
                form.append('text', content);
                // Send files_to_delete as JSON array of IDs

                if (filesToDelete.length != 0) {
                    filesToDelete.forEach(f => {
                        form.append('files_to_delete', f);
                    });
                }


                // Attach each file as a separate 'files' field (not as array)
                if (newFiles.length != 0) {
                    newFiles.forEach(f => {
                        form.append('files', f, f.name);
                    });
                }

                const headers = { 'x-api-key': apiKey };
                if (authToken) headers['Authorization'] = 'Bearer ' + authToken;

                // Log FormData entries for debug
                for (const [key, value] of form.entries()) {
                    if (value instanceof Blob) {
                        console.log(`${key}: Blob(name=${value.name || ''}, size=${value.size}, type=${value.type})`);
                    } else {
                        console.log(`${key}:`, value);
                    }
                }

                response = await fetch(getApiUrl(CONFIG.REPORTS_EDIT), {
                    method: 'PATCH',
                    headers: headers,
                    body: form
                });

                if (response.status === 401) {
                    displayStatus('Session expired. Redirecting to login...', true);
                    handleSessionExpiry();
                    return;
                }

                // Attempt to parse JSON only if present; handle empty/non-JSON bodies
                let data = null;
                const contentType = response.headers.get('content-type') || '';
                if (contentType.includes('application/json')) {
                    data = await response.json();
                }

                if (data && typeof data === 'object') {
                    if (data.ok) {
                        displayStatus('‚úÖ Rapport mis √† jour avec succ√®s !');
                        await fetchReports();
                        switchView('list');
                    } else {
                        displayStatus('√âchec de la mise √† jour du rapport : ' + (data.message || 'Erreur inconnue'), true);
                    }
                } else {
                    // No JSON body; treat 2xx as success, otherwise error
                    if (response.ok) {
                        displayStatus('‚úÖ Rapport mis √† jour avec succ√®s !');
                        await fetchReports();
                        switchView('list');
                    } else {
                        displayStatus('√âchec de la mise √† jour du rapport : HTTP ' + response.status, true);
                    }
                }
            } catch (error) {
                console.error('Error updating report:', error);
                displayStatus('Erreur lors de la mise √† jour du rapport : ' + error.message, true);
            } finally {
                // Remove loading state when done
                setButtonLoading(document.getElementById('btnSaveEdit'), false);
            }
        });

        // ===== Cancel Edit =====
        document.getElementById('btnCancelEdit').addEventListener('click', function () {
            switchView('list');
        });

        // ===== Delete Report =====
        window.deleteReport = async function (reportId) {
            if (!confirm("√ätes-vous s√ªr de vouloir supprimer ce rapport ?")) {
                return;
            }

            const apiKey = getApiKey('reports');
            if (!apiKey) {
                displayStatus('Cl√© API manquante. Veuillez vous reconnecter.', true);
                return;
            }

            const headers = {
                'accept': 'application/json',
                'x-api-key': apiKey
            };

            const authToken = getAuthToken();
            if (authToken) headers['Authorization'] = 'Bearer ' + authToken;

            try {
                const response = await fetch(getApiUrl(CONFIG.REPORTS_DELETE + '/' + reportId), {
                    method: 'DELETE',
                    headers: headers
                });

                if (response.status === 401) {
                    displayStatus('Session expired. Redirecting to login...', true);
                    handleSessionExpiry();
                    return;
                }

                // Attempt to parse JSON only if present; handle empty/non-JSON bodies
                let data = null;
                const contentTypeDel = response.headers.get('content-type') || '';
                if (contentTypeDel.includes('application/json')) {
                    data = await response.json();
                }

                if (data && typeof data === 'object') {
                    if (data.ok) {
                        displayStatus('‚úÖ Rapport supprim√© avec succ√®s !');
                        await fetchReports();
                    } else {
                        displayStatus('√âchec de la suppression du rapport : ' + (data.message || 'Erreur inconnue'), true);
                    }
                } else {
                    if (response.ok) {
                        displayStatus('‚úÖ Rapport supprim√© avec succ√®s !');
                        await fetchReports();
                    } else {
                        displayStatus('√âchec de la suppression du rapport : HTTP ' + response.status, true);
                    }
                }
            } catch (error) {
                console.error('Error deleting report:', error);
                displayStatus('Erreur lors de la suppression du rapport : ' + error.message, true);
            }
        };

        // ===== Navigation Buttons =====
        btnListView.addEventListener('click', () => switchView('list'));
        if (btnViewReport) btnViewReport.addEventListener('click', () => switchView('visual'));
        btnEditView.addEventListener('click', () => switchView('edit'));

        // ===== Show User Info =====
        const userProfile = getUserProfile();
        displayUserInfo(userInfo, userProfile, tg.initDataUnsafe?.user);

        // ===== Initialize =====
        fetchReports();

        // ===== File Preview Functions =====
        async function openFilePreview(filepath, filename, filetype) {
            const modal = document.getElementById('filePreviewModal');
            const title = document.getElementById('previewTitle');
            const body = document.getElementById('previewBody');
            const downloadBtn = document.getElementById('previewDownloadBtn');

            title.textContent = filename;

            // Construct download URL with auth headers
            const apiKey = getApiKey('reports');
            const authToken = getAuthToken();
            const downloadUrl = getApiUrl('/files/' + encodeURIComponent(filepath));

            let objectUrl;

            try {
                const headers = { 'x-api-key': apiKey };
                if (authToken) headers['Authorization'] = 'Bearer ' + authToken;
                const res = await fetch(downloadUrl, { method: 'GET', headers });
                if (!res.ok) throw new Error('Network response was not ok');
                const blob = await res.blob();
                objectUrl = URL.createObjectURL(blob);
            } catch (err) {
                console.warn('Failed to load file', filepath, err);
            }

            downloadBtn.href = objectUrl;


            downloadBtn.download = filename;

            // Add auth headers to download button via data attributes for fetch fallback
            downloadBtn.setAttribute('data-filepath', filepath);
            downloadBtn.setAttribute('data-filename', filename);
            // downloadBtn.onclick = (e) => {
            //     e.preventDefault();
            //     downloadFileWithAuth(filepath, filename, apiKey, authToken);
            // };

            // Determine preview type
            const isImage = /\.(png|jpg|jpeg|gif|webp|bmp|svg)$/i.test(filename);
            const isAudio = /\.(mp3|wav|ogg|flac|aac|m4a)$/i.test(filename);
            const isVideo = /\.(mp4|webm|ogg|mkv|avi|mov)$/i.test(filename);
            const isPdf = /\.(pdf)$/i.test(filename);

            body.innerHTML = '';

            if (isImage) {
                // Display images directly
                const img = document.createElement('img');
                img.src = objectUrl;
                img.alt = filename;
                img.style.maxWidth = '100%';
                img.style.maxHeight = '60vh';
                img.style.borderRadius = '12px';
                body.appendChild(img);
            } else if (isVideo || isAudio || isPdf) {
                // Display media in iframe for audio, video, and PDF
                const iframe = document.createElement('iframe');
                iframe.src = objectUrl;
                iframe.style.width = '100%';
                iframe.style.height = '60vh';
                iframe.style.borderRadius = '12px';
                iframe.style.border = 'none';
                body.appendChild(iframe);
            } else {
                // Non-previewable file - show filename with extension
                const ext = filename.split('.').pop().toUpperCase();
                body.innerHTML = `
                    <div class="file-not-previewable">
                        <div class="file-not-previewable-icon">üìÑ</div>
                        <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">${filename}</div>
                        <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">
                            <strong>Type:</strong> ${ext} file
                        </div>
                        <div style="font-size: 13px; color: var(--text-secondary);">Ce fichier ne peut pas √™tre pr√©visualis√© en ligne.</div>
                        <div style="font-size: 13px; color: var(--text-secondary); margin-top: 12px;">Cliquez sur le bouton T√©l√©charger ci-dessous pour ouvrir le fichier.</div>
                    </div>
                `;
            }

            modal.classList.add('active');
        }


        // ===== Report View (full report visualization moved to Visual tab) =====
        window.openReportView = function (reportId, day, userId) {
            // find report similar to editReport
            let report = null;
            if (userId !== undefined) {
                const userData = allReports?.[userId];
                const dayData = userData?.items?.[day];
                report = dayData?.records?.find(r => r.id === reportId);
            } else {
                const dayData = allReports?.items?.[day];
                report = dayData?.records?.find(r => r.id === reportId);
            }

            if (!report) {
                displayStatus('Rapport introuvable', true);
                return;
            }

            // Populate the read-only visual tab
            const titleEl = document.getElementById('reportFullTitle');
            const metaEl = document.getElementById('reportFullMeta');
            const contentEl = document.getElementById('reportFullContent');
            const attachmentsEl = document.getElementById('reportFullAttachments');

            titleEl.textContent = report.title || '';
            const timeText = report.time || report.created_at || '';
            metaEl.textContent = `üïê ${timeText} ‚Ä¢ ID: ${report.id}` + (day ? ` ‚Ä¢ Date: ${day}` : '') + (userId !== undefined ? ` ‚Ä¢ User: ${userId}` : '');
            contentEl.innerHTML = report.content?.text || '<div style="color:#718096">(Pas de contenu)</div>';

            attachmentsEl.innerHTML = '';
            const files = report.content?.files || [];
            if (files.length > 0) {
                files.forEach(f => {
                    const rawPath = f.path || f.name || '';
                    const subpath = (rawPath || '').replace(/^files[\\/]/i, '').replace(/\\/g, '/');
                    const isImage = /\.(png|jpg|jpeg|gif|webp|bmp|svg)$/i.test(f.name || '');

                    if (isImage) {
                        const img = document.createElement('img');
                        img.setAttribute('data-filepath', subpath);
                        img.alt = f.name || '';
                        img.style.width = '120px';
                        img.style.height = '120px';
                        img.style.objectFit = 'cover';
                        img.style.borderRadius = '8px';
                        img.style.cursor = 'pointer';
                        img.onclick = () => openFilePreview(subpath, f.name || subpath, f.type || '');
                        attachmentsEl.appendChild(img);
                    } else {
                        const btn = document.createElement('button');
                        btn.className = 'report-file-link';
                        btn.style.cursor = 'pointer';
                        btn.textContent = f.name || subpath;
                        btn.onclick = () => openFilePreview(subpath, f.name || subpath, f.type || '');
                        attachmentsEl.appendChild(btn);
                    }
                });

                // If there's a helper to attach previews, call it (images have data-filepath for lazy loading)
                if (typeof attachFilePreviews === 'function') {
                    try { attachFilePreviews(attachmentsEl); } catch (e) { /* ignore */ }
                }
            }

            // Switch to visual tab
            switchView('visual');
        };

        function closeReportView() {
            // kept for compatibility with modal close handlers; switch back to list
            switchView('list');
        }


        function closeFilePreview() {
            const modal = document.getElementById('filePreviewModal');
            modal.classList.remove('active');
            document.getElementById('previewBody').innerHTML = '';
        }

        // Close modal when clicking outside
        document.getElementById('filePreviewModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeFilePreview();
            }
        });
    </script>
</body>

</html>